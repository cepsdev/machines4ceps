<!DOCTYPE html>
<html lang=en>
<!-- 
    
    Cool effects

    https://blog.trackduck.com/2015/06/10/15-impressive-pop-animation-effects-codepen/
    
    
    -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="(c) ceps technologies, all rights reserved">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="jquery-ui/jquery-ui.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- link href="datatables/css/dataTables.material.min.css" rel="stylesheet" -->
    <!-- link href="datatables/css/jquery.dataTables.min.css" rel="stylesheet" -->
    <link href="datatables/css/dataTables.bootstrap.min.css" rel="stylesheet" >
    <link href="datatables-responsive/dataTables.responsive.css" rel="stylesheet">
    <link href="cepscloud-ui/cepscloud-ui.css" rel="stylesheet">
    <link href="animate/animate.css" rel="stylesheet">
    <style>
    </style>
    <title>Prototype Control Panel</title>
</head>

<script>
    var global_observer_handlers = [];

    function register_observer(name, fn) {
        for (let e of global_observer_handlers)
            if (e.name == name) { e.handler = fn; return; }
        if (fn == undefined) return;
        for (let e of global_observer_handlers)
            if (e.handler == undefined) { e.name = name; e.handler = fn; return; }

        global_observer_handlers.push({name:name, handler:fn});
    }

    function unregister_observer(name) { register_observer(name, undefined); }

    function set_page_title(s) {
        $("#page_title").html(s);
    }

    function warn(s) {
        $.notify({/* options*/message: s
        },
            {/*settings*/ delay: 10000, type: 'warning', showProgressbar: false,
                animate: { enter: 'animated zoomInDown', exit: 'animated zoomOutUp' }
            }
        );        
    }
</script>


<body>

    <div class="row">
        <div class="col-xs-6 col-sm-2"></div>
        <div class="col-xs-6 col-sm-8">
            <h2><span id="page_title">Query</span></h2>
        </div>
        <div class="col-xs-6 col-sm-2"></div>
    </div>


    <div class="row">
        <div class="col-xs-6 col-sm-2">

        </div>
        <div class="col-xs-6 col-sm-8">
            <div class="input-group">
                <span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span>
                <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                <input id = "query" type="text" class="form-control" name="user" value="" placeholder="Type cepS Query here">
            </div>
          </div>
        <div class="col-xs-6 col-sm-2">
            <div class="input-group">
                <button id="query_send" type="button" class="btn btn-primary">Send</button>
            </div>
        </div>
        </div>


    <div class="row">
        <div class="col-xs-6 col-sm-2">
            
        </div>
        <div class="col-xs-6 col-sm-8">
            <p></p><p></p>
            <div class="panel panel-default">
                <div class="panel-body" id="query_results"></div>     
            </div>
         </div>
         <div class="col-xs-6 col-sm-2"></div>
     </div>



    <!---------------------------- COMPONENT: Login ---------------------------->
    <div class="modal fade" id="dlg_login" tabindex="-1" role="dialog" aria-labelledby="dlg_login" style="z-index: 10000;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Connect</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-log-in"></i></span>
                        <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                        <input id="sim_url" type="text" class="form-control" name="user" value="localhost:1063" placeholder="">
                    </div>                      
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary" onclick="login($('#sim_url').val());">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Login ---------------------------->





 

    <!---------------------------- COMPONENT: Choose Signal ---------------------------->
    <div class="modal fade" id="dlg_select_a_signal" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_signal_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Choose a Signal</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <table id="dlg_select_a_signal_table" class="table table-striped table-bordered" width="100%"></table>

                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Signal ---------------------------->


    <!---------------------------- COMPONENT: Choose Simulation ---------------------------->
    <div class="modal fade" id="dlg_select_a_simulation" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_simulation_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_simulation_label">Choose a Simulation</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <table id="dlg_select_a_simulation_table" class="table table-striped table-bordered" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Simulation ---------------------------->


    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
    <div class="modal fade" id="dlg_select_a_ctrlpanel" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_ctrlpanel_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_ctrlpanel_label">Choose a Control Panel</h4>
                </div>
                <div id="dlg_select_a_ctrlpanel_body" class="modal-body">
                    <table id="dlg_select_a_ctrlpanel_table" class="table table-striped table-bordered" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_ctrlpanel_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                 </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
       
    <!---------------------------- COMPONENT: Save Control Panel ---------------------------->
        <div class="modal fade" id="dlg_save_control_panel" tabindex="-1" role="dialog" aria-labelledby="dlg_save_control_panel" style="z-index: 10000;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="dlg_save_control_panel_label">Save Control Panel</h4>
                    </div>
                    <div id="dlg_save_control_panel_body" class="modal-body">
                        <div class="form-group">
                            <label for="save_control_panel_name">Name</label>
                            <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                            <input id="save_control_panel_name" type="text" class="form-control" name="save_control_panel_name" value="" placeholder="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary" onclick="$('#dlg_save_control_panel').modal('hide');save_active_control_panel($('#save_control_panel_name').val());">Ok</button>
                    </div>
                </div>
            </div>
        </div>
     <!---------------------------- COMPONENT: Save Control Panel ---------------------------->




    <script src="jquery/js/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="jquery-ui/jquery-ui.min.js"></script>
    <script src="datatables/js/jquery.dataTables.min.js"></script>
    <script src="datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script src="datatables-responsive/dataTables.responsive.js"></script>
    <script src="chartjs/Chart.js"></script>
    <script src="bootstrap-notify/bootstrap-notify.js"></script>
    <script src="cepscloud-ui/widget_properties_panel.js"></script>
    <script src="cepscloud-ui/widget_toggle_signal.js"></script>
    <script src="cepscloud-ui/widget_plot_signal.js"></script>
    <script src="cepscloud-ui/persistence.js"></script>

    <script>
        let ctrlPanelEditor = undefined;
        let partitions = [];
        let constraints = [];
    </script>

    <!---------------------- Persistence --------------------- -->

    <script>
        let ctrlpanel_infos = [];
        let dlg_select_a_ctrlpanel_table = undefined;

        function set_ctrlpanel_infos(l) {
            if (l.length == 0) {
                    ctrlpanel_infos = []; return;
            }
            ctrlpanel_infos = new Array(l.length);
            for (let i = 0; i != l.length; ++i) {
                    ctrlpanel_infos[i] = l[i];
                ctrlpanel_infos[i].id = i;
            }
        }

        function get_ctrlpanel_infos() {
            return ctrlpanel_infos;
        }

        function ctrlpanel_info_get_name(ctrlpanel) {
            for (let e of ctrlpanel.content) {
                if (e.type != "struct" || e.name != "name" || e.content.length != 1) continue;
                return e.content[0];
            }
            return undefined;
        }

        function ctrlpanel_info_get_widget_property(e,n) {
            for (let ee of e.content) {
                if (ee.type == "struct" && ee.name == n) return ee.content;
            }
            return undefined;
        }

        function widget_descr_extract_type(widget_descr_type_prop) {
            if (widget_descr_type_prop.length == 0) return undefined;
            return widget_descr_type_prop[0];
        }

        function widget_descr_extract_assoc_sysstate(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            if (e[0].type == "symbol" && e[0].kind == "Systemstate") return e[0].name;
            return undefined;
        }

        function widget_descr_extract_style(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            let r = {};
            for (let ee of e) {
                if (ee.type != "struct") continue;
                if (ee.name == "height") r.height = ee.content[0];
                else if (ee.name == "width") r.width = ee.content[0];
            }
            return r;
        }

        function ctrlpanel_info_get_widget_descr(e) {
            
            if (e.type != undefined && e.type == "struct" && e.name == "widget") {
                try {
                    let t = undefined;                   
                    return [true, {
                        type: (t = ctrlpanel_info_get_widget_property(e, "type")) != undefined ? widget_descr_extract_type(t) : undefined,
                        associated_systemstate: (t = ctrlpanel_info_get_widget_property(e, "associated_systemstate")) != undefined ? widget_descr_extract_assoc_sysstate(t) : undefined,
                        style: (t = ctrlpanel_info_get_widget_property(e, "style")) != undefined ? widget_descr_extract_style(t) : undefined
                    }];
                } catch (error) {
                    
                }
            }
            return [false];
        }




        function ctrlpanel_dlg_decorate_ctrlpanel_table_entry(e,pnl_info) {
            return "<a href='#' onclick='load_ctrlpanel_given_id(" + pnl_info.id+");'>" + e + "</a>";
        }

        function choose_ctrlpanel_dlg() {
                    let data = [];
            columns = [{title: "Name" }];
            //["<a href='#' onclick='handle_signal_select(\"" + sig.name + "\");'>" + sig.name + "</a>", sig.comment]
            get_ctrlpanel_infos().forEach((elem) => {
                    let t = ctrlpanel_info_get_name(elem);
                if (t == undefined) data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry("<i>No Title</i>", elem)]);
                else data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry(t, elem)]);
            })

            dlg_select_a_ctrlpanel_table = $('#dlg_select_a_ctrlpanel_table').DataTable({
                    select: {
                    style: 'single'
                },
                data: data,
                columns: columns
            });
            $("#dlg_select_a_ctrlpanel").modal("show");
        }

        function load_ctrlpanel_given_id(id) {
            $("#dlg_select_a_ctrlpanel").modal("hide");
            let cpnl_info = undefined;
            for (let e of ctrlpanel_infos) {
                if (e.id == id) {
                    cpnl_info = e;
                    break;
                }
            }
            if (cpnl_info == undefined) return;
            build_ctrlpanel_from_json(ctrlPanelEditor, cpnl_info);
        }
    </script>


    <!---------------------- Persistence ----------------------->

    <!---------------------- Signals ----------------------->
    <script>
        function Signalinfo(n, v, tv, c, s, r, f, i) {
            this.name = n;
            this.value = v;
            this.target_value = tv;
            this.comment = c;
            this.sender = s;
            this.receiver = r;
            this.frames = f;
            this.info = i;
            this.observed_min = undefined;
            this.observed_max = undefined;
            this.target_value_changed = false;
        }
        var signals = [];
        var signals_dt = undefined;



    </script>
    <!---------------------- Signals --------------------- -->
    
    
    

    <script>
        var dlg_select_a_signal_table_dataset = [];        

        var dlg_select_a_signal_table_columns = [
            { title: "Name" },
            { title: "Comment" },
        ];

        const slider_granularity_default = 4096;

        function generate_test_data() {
            signals = [
                new Signalinfo("Signal A", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], {type:"float",min:-2,max:2}),
                new Signalinfo("Signal B", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10 }),
                new Signalinfo("Signal C", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal D", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal E", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val:1, name: "b" }, { val:2, name:"c" }] }),
                new Signalinfo("Signal F", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal G", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal H", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal I", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal J", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal K", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal L", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal M", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal N", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal O", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal P", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal Q", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal R", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal S", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal T", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal U", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal V", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal W", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal X", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" })
            ];
        }

        function set_signal_target_value(widget_id, tv, signal_name) {            
            let sig = get_signal_by_name(signal_name);
            sig.target_value = tv;
            sig.target_value_changed = true;
            for (let e of widget_infos) {
                if (e.id == widget_id) continue;             
                if (e.info.type.sig && e.info.toggle_sig && (e.info.sig_name == signal_name) ) {
                    e.ext.set_value(tv);
                }
            }
            if (simcore_ws && connected) setTimeout(
                () => {
                    let cmd = "SET_VALUE_NO_REPLY";
                    cmd += " " + sig.name;
                    if (sig.info.type == "float") cmd += " number";
                    else cmd += " int";
                    cmd += " " + sig.target_value.toString();
                    sig.target_value_changed = false;                    
                    simcore_ws.send(cmd);
                }, 0
            );
        }

        function map_sig_target_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2,31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31))+1;
        
            d = (mx - mn);
            if (d == 0) return 0;
            let rr = ((signal.target_value - mn) / d) * r;
            return rr;
        }

        function map_sig_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((signal.value - mn) / (d)) * r;
            return rr;
        }

        function map_range_index_to_value(signal, r, i) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((i / r) * d) + mn;
            if (signal.info.type == "float")
                return Math.round(rr * 10000) / 10000.0;
            if (signal.info.type == "int") {
                rr = Math.min(Math.round(rr), signal.info.max);
                if (rr < signal.info.min) rr = signal.info.min;
                return rr;
            }
            else return rr;
        }

        //generate_test_data();

        function get_signal_by_name(n) {
            for (let e of signals) if (e.name == n) return e;
            return undefined;
        }

        function apply_constraints_to_signals(constraints) {
            for (let expr of constraints) {
                if (expr.type == "binop") {
                    let lhs = expr.left;
                    let rhs = expr.right;
                    if (expr.name == "<=") { expr.name = ">="; let t = rhs; rhs = lhs; lhs = t; }
                    if (expr.name == "<") { expr.name = ">"; let t = rhs; rhs = lhs; lhs = t; }
                    if (lhs.type == "symbol" && lhs.kind == "Systemstate") {
                        sig = get_signal_by_name(lhs.name); if (sig == undefined) continue;
                        if (expr.name == ">=" || expr.name == ">") {
                            let t = sig.info.min;
                            if (sig.info.min != undefined) sig.info.min = Math.max(sig.info.min, rhs);
                            else sig.info.min = rhs;
                            if (sig.info.min == undefined) sig.info.min = t;
                        }
                    } else if (rhs.type == "symbol" && rhs.kind == "Systemstate") {
                        sig = get_signal_by_name(rhs.name); if (sig == undefined) continue;
                        if (expr.name == ">=" || expr.name == ">"){
                            let t = sig.info.max;
                            if (sig.info.max != undefined) sig.info.max = Math.min(sig.max, lhs);
                            else sig.info.max = lhs;
                            if (sig.info.max == undefined) sig.info.max = t;
                        }
                    }
                }
            }
        }

        function apply_partitions_to_signals(partitions) {
            function get_signal(cont) {
                for (let e of cont) {
                    if (e.type == "struct" && e.name == "of") {
                        if (e.content[0].type != undefined && e.content[0].type == "symbol")
                            return get_signal_by_name(e.content[0].name);
                        return get_signal_by_name(e.content[0]);
                    }
                }
                return undefined;
            }
            for (let p of partitions) {
                let sig = get_signal(p.content);
                sig.info.vm = [];
                for (let e of p.content) {
                    if (e.type == "scope" && e.content.length > 1) {
                        let expr = e.content[0];
                        if (expr.type != "binop" || expr.name != "==") continue;
                        let lhs = expr.left;
                        let rhs = expr.right;
                        if (typeof lhs != "number")[lhs, rhs] = [rhs, lhs];
                        if (typeof lhs != "number") continue;
                        if (rhs.type != "symbol" || rhs.kind != "Systemstate" || rhs.name != sig.name) continue;
                        sig.info.vm.push({ val: lhs, name: e.content[1]});                      
                    }
                }
            }
        }
        
        
        function dlg_select_a_signal_populate_dataset(){
            ds = [];
           
            for (let sig of signals) {               
                ds.push(["<a href='#' onclick='handle_signal_select(\"" + sig.name+"\");'>"+sig.name+"</a>",sig.comment]);
            }

            return ds;            
        }

        function Widget(id) { this.type_ = "undefined"; }
        Widget.prototype.type = function () { return this.type_; }
        Widget.prototype.set_type = function (t) { this.type_ = t; }

        function dlg_set_widget_type_get_results() {
            return {
                toggle_signal: $("#dlg_set_widget_type_r1").is(":checked"),
                show_signal: $("#dlg_set_widget_type_r2").is(":checked"),
                plot_signal: $("#dlg_set_widget_type_r3").is(":checked"),
                trigger_event: $("#dlg_set_widget_type_r4").is(":checked"),
                run_script: $("#dlg_set_widget_type_r5").is(":checked")
            };
        }

        function helper_make_toggle_widget_sel_list(signal,v) {
            let l = ["- No Mapping Available -"];
            let sel_index = 0;
            let i = 1;
            for (e of signal.info.vm) {
                l.push(e.name);
                if (Math.abs(v) < Number.MIN_VALUE)
                { if (Math.abs(v - e.val) <= Number.MIN_VALUE) sel_index = i; }
                else
                { if (Math.abs(v - e.val) / Math.abs(v) <= Number.MIN_VALUE) sel_index = i; }
                ++i;
            }
            return [l,sel_index];
        }

        function helper_display_unit_and_format(unit, format){
            let r = "";
            if (unit == undefined || unit.length == 0) r += "scalar"; else r += unit;
            if (format == "Hexadecimal") r += " <small>( hex. )</small>";
            else if (format == "Octal") r += " <small>( oct. )</small>";
            else if (format == "Binary") r += " <small>( bin. )</small>";
            else r += " <small>( dec. )</small>";
            return r;
        }

        function helper_make_widget_content_with_loader() {
            
            return `<table width="100%" valign="center">
                     <tr>
                      <td width="70px"><div class="loader" style="float: left;"></div></td>
                      <td width="15px"></td><td align="left"><h4><span class="label label-default">Fetching Data</span></h4></td>
                     </tr>
                    </table>`;
        }

        function helper_make_toggle_widget_content(widget_id, signal, watch) {
            if (watch == undefined) watch = false;
            let widget_content = "";
            if (signal.value == undefined) {
                widget_content = helper_make_widget_content_with_loader();                    
            }
            else {
                if (signal.info.vm != undefined && signal.info.vm.length > 0) {
                    let [l, sel_index] = helper_make_toggle_widget_sel_list(signal, signal.target_value);
                    widget_content =
                        `
                 <table width='100%'>
                  <tr>
                   <td width='50%'>
                     <div id='dummy_${widget_id}'></div>
                   </td>
                   <td width='50%'>
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                       <select id="${widget_id}_select_ctrl" class="form-control">
                          ${helper_build_sel_html(l, sel_index)}
                        </select>
                        <input type ="text" style="width:100%;" id="${widget_id}_text_ctrl" 
                               class="form-control" value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                               ${watch ? "disabled" : "enabled"}>
                        <span class="input-group-addon" >${helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>                        
                    </div>
                  </td>
                 </tr>
                </table>`;

                } else {
                    widget_content =
                        `
                <table width="100%">
                 <tr>
                  <td style="min-width:30px;width:50%;">
                   <div id='dummy_${widget_id}'></div>
                  </td>
                  <td style="min-width:160px;width:50%;"> 
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                    <input type ="text" style="width:100%;"
                           id="${widget_id}_text_ctrl" 
                           class="form-control"
                           value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                           ${watch ? "disabled" : "enabled"}>
                    <span class="input-group-addon" >${ helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>
                   </div>
                  </td>
                 </tr>
                </table>`;
                }
            }
            
            return widget_content;
        }

        function check_constraints(signal, v) {
            if (signal == undefined || signal.info == undefined) return [true];
            let mx = signal.info.max;
            let mn = signal.info.min;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;

            if (v < mn) return [false, "Too Small."];
            if (v > mx) return [false, "Too Big."];
            return [true];
        }

        function validate_input(signal, text, format) {
            let v = NaN;
            if (signal.info.type == "float") {
                v = parseFloat(text);
            } else if (signal.info.type == "int") {
                
                if (format == "Hexadecimal") {
                    if (text.match(/^(\-)?([0-9]|a|b|c|d|e|f)+$/)) v = parseInt(text, 16);
                } else if (format == "Octal") {
                    if (text.match(/^(\-)?([0-7])+$/))v = parseInt(text, 8);
                } else if (format == "Binary") {
                    if (text.match(/^(\-)?([0-1])+$/))v = parseInt(text, 2);
                } else {
                    if (text.match(/^(\-)?([0-9])+$/)) v = parseInt(text);
                }
            }
            if (!isNaN(v)) {
                let r = check_constraints(signal,v);
                if (!r[0]) return [r[0], v, r[1]];
            }

            return [!isNaN(v),v, text.length==0 ? "No Input" : "That's not a number"];
        }
        function sig_value_text_representation(signal, v, format) {
            if (signal.info.type == "int") {
                if (format == "Hexadecimal") return v.toString(16);
                else if (format == "Octal") return v.toString(8);
                else if (format == "Binary") return v.toString(2);                 
            }
            return v.toString();
        }
        
        function handle_widget_click_header(widget_id, ev) {
            
            event.preventDefault();
            $(".baseWidget-selected").removeClass("baseWidget-selected");
            let widget = $("#" + widget_id); 
            widget.addClass("baseWidget-selected");

            $("#widget_properties_panel").removeClass("prop-panel-transition-1");
            $("#widget_properties_panel").removeClass("prop-panel-transition-2");
            $("#widget_properties_panel").addClass("prop-panel-transition-2");

            update_prop_panel(widget);
            return false;
        }

        function CtrlPanelComponentTemplates() {
            this.id_counter = 0;
        }

        function close_widget(ev,widget_id) {
            ev.stopPropagation();
            $("#" + widget_id).addClass("baseWidget-remove");
            
            setTimeout(() => {
                $("#" + widget_id).remove();
            }, 500);
            return false;
        }

        CtrlPanelComponentTemplates.prototype.baseWidget = function () {
            this.id_counter++;
            return [`widget_${this.id_counter}`,`<div id="widget_${this.id_counter}" class="baseWidget baseWidget-not-initialized">
                    <div id="header_of_widget_${this.id_counter}" class="header" onclick="handle_widget_click_header('widget_${this.id_counter}',event)"> 
                      <i>Click to configure...</i>
                      <button type="button" class="btn btn-xs close" aria-label="Close" onclick="close_widget(event,'widget_${this.id_counter}');" style="transform: translateY(-11px);">
                        <span aria-hidden="true" class="small" >&times;</span>
                      </button>
                    </div>
                    <div id="content_of_widget_${this.id_counter}" class="baseWidget-content"></div>
                    <div id="footer_of_widget_${this.id_counter}" class="baseWidget-footer"></div>   
                    </div>
                    </div>
                    `];
        }
        CtrlPanelComponentTemplates.prototype.paragraph = function () {
            return `<br>`;
        }

        function CtrlPanelEditor(ctrl_editor_component, widget_templates, name) {
            this.ctrl_editor_component_ = ctrl_editor_component;
            this.widget_templates_ = widget_templates;
            this.name = name;
        }
        CtrlPanelEditor.prototype.set_name = function (n) { this.name = n; if (n != undefined) set_page_title("Control Panel <strong>" + n + "</strong>"); else set_page_title("Control Panel <i style='color:red;'> - No Title - </i>");}
        CtrlPanelEditor.prototype.get_name = function () { return this.name; }
        CtrlPanelEditor.prototype.view = function () { return this.ctrl_editor_component_; }
        CtrlPanelEditor.prototype.clear = function () {
            widget_infos = [];
            $(this.ctrl_editor_component_).html("");
        }
        CtrlPanelEditor.prototype.widgetTemplates = function () { return this.widget_templates_; }
        CtrlPanelEditor.prototype.addWidget = function () {
            let r = this.widgetTemplates().baseWidget();
            this.ctrl_editor_component_.append(r[1]);
            return r[0];
        }
        CtrlPanelEditor.prototype.addParagraph = function () {
            this.ctrl_editor_component_.append(this.widgetTemplates().paragraph());
        }

       
    </script>



    <script>
        function traverse_ceps_as_json(doc, f) {
            if (doc === undefined) return true;
            if (Object.prototype.toString.call(doc) == "[object Array]") {
                for (let e of doc) {
                    if (!f(e)) return false;
                    if(!traverse_ceps_as_json(e, f)) return false;
                }
                return true;
            } else if (doc.content) {
                return(traverse_ceps_as_json(doc.content, f));
            }
            return f(doc);
        }

    </script>

    <script>
        var connected = false;
        var new_remote_site  = false;
        var remote_url = undefined;
        var simcore_ws = undefined;
        var global_sysstates = [];

        function simcore_ws_process_messages(ev) {
            let msg = JSON.parse(ev.data);
            if (!msg.ok) return;
            if (msg.signals) {
               for (let s of msg.signals) {
                   let sig = get_signal_by_name(s.name);
                   if (!sig) continue;
                   sig.value = s.value;
                   if (sig.target_value == undefined) sig.target_value = sig.value;
                   if (sig.observed_min == undefined || sig.observed_max == undefined) {
                       sig.observed_min = sig.value;
                       sig.observed_max = sig.value;
                   } else {
                       sig.observed_min = Math.min(sig.value, sig.observed_min);
                       sig.observed_max = Math.max(sig.value, sig.observed_max);
                   }


                   for (let wi of widget_infos) {
                       if (wi.info.type.sig && !wi.info.toggle_sig && (wi.info.sig_name == s.name)) {
                           if (wi.ext && wi.ext.set_value) wi.ext.set_value(sig.value);
                       }
                   }

               }
            }
        }

        function finish_prologue(ws) {
            ws.addEventListener("message", simcore_ws_process_messages);
            simcore_ws = ws;
            connected = true;
            if (new_remote_site) {
                if (get_ctrlpanel_infos().length) setTimeout(() => { choose_ctrlpanel_dlg(); }, 1000);
            }
        }

        function fetch_partitions(ws) {
            function h(m) {
                ws.removeEventListener("message", h);
                partitions = [];
                try {
                    let msg = JSON.parse(m.data);
                    if (msg.ok) {
                        partitions = msg.sresult;
                        apply_partitions_to_signals(partitions);
                    }
                } catch (err) { console.log(err);}
                finish_prologue(ws);
            }
            ws.send('QUERY root.as_identifier("partition");');
            ws.addEventListener("message", h);
        }

        function fetch_constraints(ws) {
            function h(m) {
                constraints = [];
                ws.removeEventListener("message", h);
                try {
                    let msg = JSON.parse(m.data);
                    if (msg.ok) {
                        constraints = msg.sresult;
                        apply_constraints_to_signals(constraints);
                    }
                } catch (err) { console.log(err); }
                fetch_partitions(ws);
            }
            ws.send("QUERY root.constraints.content();");
            ws.addEventListener("message", h);
        }

        function fetch_frames_from_simcore(ws) {

            $.notify({/* options*/message: 'Connected with \'' + remote_url + `'` },
                {/*settings*/ type: 'success', showProgressbar: false, delay: 2000,
                    animate: { enter: 'animated rollIn', exit: 'animated rollOut' }
                }
            );

            ws.send("QUERY root.frame;");
            function process_ctrlpanels_resultset(ev) {
                let msg = JSON.parse(ev.data);
                if (msg.ok) {
                    set_ctrlpanel_infos(msg.sresult);
                }
                ws.removeEventListener("message", process_ctrlpanels_resultset);
                fetch_constraints(ws);
                //finish_prologue(ws);
            }
            function process_frames_resultset(ev) {
                let msg = JSON.parse(ev.data);
                //console.log(msg);
                if (msg.ok) {
                    ws.removeEventListener("message", process_frames_resultset);
                    let set_of_signals = new Set();
                    traverse_ceps_as_json(msg.sresult, (entry) => {
                        if (entry.type != undefined) if (entry.type == "symbol" && entry.kind == "Systemstate") {
                            set_of_signals.add(entry.name);
                        }
                        return true;
                    });
                    let list_of_signals = Array.from(set_of_signals).sort();
                    for (let s_name of list_of_signals) {
                        signals.push(new Signalinfo(s_name, undefined, undefined, /*comment*/"",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: undefined, max: undefined }));
                    }
                    traverse_ceps_as_json(msg.sresult, (entry) => {
                        if (entry.type != undefined && entry.type == "struct" && entry.name == "comment") {
                            for (let e of entry.content) {
                                if (e.type == undefined || e.type != "struct" || e.name != "sig") continue;
                                let sig = undefined;
                                let comment = undefined;
                                for (let ee of e.content) {
                                    if (ee.type == undefined || ee.type != "struct") continue;
                                    if (ee.name == "name") sig = get_signal_by_name(ee.content[0]);
                                    else if (ee.name == "comment") comment = ee.content[0];
                                }
                                if (comment != undefined && sig != undefined)
                                    sig.comment = comment;
                            }
                            return false;
                        }
                        return true;
                    });

                    for (let e of signals) {
                        for (let ee of global_sysstates) {
                            if (e.name != ee.name) continue;
                            if (ee.type == "int") e.info.type = "int";
                            else if (ee.type == "float") e.info.type = "float";
                            break;
                        }
                    }
                    ws.addEventListener("message", process_ctrlpanels_resultset);
                    ws.send("QUERY root.ctrlpanels.content();");
                }
            };

            ws.addEventListener("message", process_frames_resultset );
        }

        var dlg_select_a_simulation_table_data = undefined;

        function connect_to_simcore(url) {
            main_socket.removeEventListener("open", on_ws_initial_connect);
            main_socket.removeEventListener("close", on_ws_close);
            main_socket.removeEventListener("error", on_ws_error);
            do_login(url);
        }

        function fetch_data_from_simcore(ws) {
            function h(ev) {
                ws.removeEventListener("message", h);
                console.log(ev.data);
                let msg = JSON.parse(ev.data);
                if (msg.ok) {
                    global_sysstates = msg.global_states;
                }
                fetch_frames_from_simcore(ws);
            }
            ws.addEventListener("message", h);
            ws.send("GLOBAL_SYSSTATES");
        }

        function fetch_data_from_remote(ws) {
            ws.send("KNOWN_SIMCORES");
            function h(ev) {
                ws.removeEventListener("message", h);                
                let msg = JSON.parse(ev.data);                
                if (msg.ok) {
                    let dt = [];
                    for (let e of msg.simcores) {
                        let hn = (e.host_name.length == 0 ? "localhost" : e.host_name);
                        let url = hn + ":" + e.ws_api_port;
                        dt.push([`<a href="#" onclick="$('#dlg_select_a_simulation').modal('hide');connect_to_simcore('${url}')" >`+e.name+"</a>",
                            e.short_name, url]);
                    }
                    if (dt.length == 0) {
                        fetch_data_from_simcore(ws);
                        return;
                    }
                    $("#dlg_select_a_simulation").modal("show");
                    if (dlg_select_a_simulation_table_data == undefined)
                        dlg_select_a_simulation_table_data = $('#dlg_select_a_simulation_table').DataTable({
                            select: {
                                style: 'single'
                            },
                            data: dt,
                            columns: [{ title: "Name" }, { title: "Short Name" }, {title:"Host"}]
                        });
                    else {
                        $('#dlg_select_a_simulation_table').DataTable().clear().rows.add(dt).draw();
                    }
                    return;
                }
                fetch_data_from_simcore(ws);
            }
            ws.addEventListener("message", h);
        }

        var login_retry_timeout = undefined;
        function stop_login_retry_timeout() {
            if (login_retry_timeout == undefined) return;
            window.clearTimeout(login_retry_timeout);
            login_retry_timeout = undefined;
        }

        function enter_credentials() {
           $('#dlg_login').modal('show');
        }

        var failed_connect_notification_container = undefined;
        function show_failed_connect_notification(url) {
            if (failed_connect_notification_container != undefined) {
                failed_connect_notification_container.close();
            }
            var time_elapsed_to_retry_connect = 10;
            function time_elapsed_to_retry_connect_fn(){
                --time_elapsed_to_retry_connect;
                if (time_elapsed_to_retry_connect <= 0) {
                    if (failed_connect_notification_container != undefined) {
                        failed_connect_notification_container.close();
                        setTimeout(() => { do_login(remote_url); }, 1500);
                    }
                } else {
                    $("#info_btn_log_again").html(time_elapsed_to_retry_connect.toString());
                    login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
                }
            }
            login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
            failed_connect_notification_container=
            $.notify({/* options*/message: 'Failed to connect with \'' + url +
                `' <p></p><button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick="stop_login_retry_timeout();do_login('${remote_url}');">Try again in <span id="info_btn_log_again">${time_elapsed_to_retry_connect}</span> seconds</button>&nbsp;&nbsp;` +
                `<button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick=" stop_login_retry_timeout();enter_credentials();">Reenter Credentials</button>`
            },
                {/*settings*/ delay: 0, type: 'danger', showProgressbar: false,
                    animate: { enter: 'animated zoomInDown', exit: 'animated zoomOutUp' }
                }
            );                    
        }

        function connection_lost() {
            connected = false;
            simcore_ws = undefined;
            let l = $(".depend-on-signal-data");
            for (let e of l) {
                $(e).addClass("waiting-for-data");
            }
            for (let s of signals) {
                s.value = undefined;
            }
            setTimeout(() => { for (let e of l) update_widget_ctrl($(e)); }, 10);
            show_failed_connect_notification(remote_url);
        }


        let main_socket = undefined;
        function on_ws_initial_connect(ev) {
                 
            fetch_data_from_remote(main_socket);
        }

        function on_ws_close(ev) {
            if (main_socket != simcore_ws) return;
            connection_lost();                    
        }

        function on_ws_error(ev) {
            connected = false; simcore_ws = undefined;
            connection_lost();
        }

        function do_login(url) {
            new_remote_site = remote_url != url;
            remote_url = url;          
            connected = false;
            main_socket = new WebSocket("ws://"+url);
            main_socket.addEventListener("open", on_ws_initial_connect);
            main_socket.addEventListener("close", on_ws_close);
            main_socket.addEventListener("error", on_ws_error);                
        }

        function login(url) {
            $('#dlg_login').modal('hide');
            do_login(url);
        }

        function get_indent(n) {
            let s = "";
            for (let i = 0; i != n ; ++i) s += " ";
            return s;
        }

        function cepsjson2txt_helper(e, indent) {
            if (e.type != undefined) {
                if (e.type == "struct") {
                    let sc = "";
                    for (let ee of e.content) {
                        sc += cepsjson2txt_helper(ee, indent + 1) + "\n";
                    }
                    return get_indent(indent) + e.name + " {\n" + sc + get_indent(indent) + "};";
                } else if (e.type == "symbol") {
                    return get_indent(indent) + e.name;
                } else if (e.type == "binop") {
                    return get_indent(indent) + cepsjson2txt_helper(e.left, 0) + e.name + cepsjson2txt_helper(e.right, 0)  ;
                }
            }
            if (typeof(e) ==  "string") return get_indent(indent) + e;
            return e;
        }

        function cepsjson2txt(cj) {
            console.log(cj);
            let s = "";
            let indent = 0;
            for (let e of cj) {
                s += cepsjson2txt_helper(e,indent);
            }
            return s;
        }
        
        $(document).ready(() => {
            //$(document).click(() => { $(".baseWidget-selected").removeClass("baseWidget-selected"); });
            init_widget_properties_panel();
            setInterval(() => {
                for (let e of global_observer_handlers) if (e.handler != undefined) e.handler();
             } , 10);

            setInterval(() => {
                
                let not_connected_widgets = $(".waiting-for-data");
                if (not_connected_widgets.length && connected && simcore_ws) {
                     for (let e of not_connected_widgets) {
                        let signal_name = $(e).attr("attached-signal");
                        let sig = get_signal_by_name(signal_name);
                        if (sig.value != undefined) {
                            $(e).removeClass("waiting-for-data");
                            setTimeout(() => { update_widget_ctrl($(e)); }, 10);
                        } else simcore_ws.send("WATCH "+signal_name);
                    }                    
                }
            } , 500);    
            
            ctrlPanelEditor = new CtrlPanelEditor($('#ctrl_panel_editor'), new CtrlPanelComponentTemplates() );

            $('#ctrl_panel_editor_btn_add').on('click', (ev) => {
                ctrlPanelEditor.addWidget();
            });
            $('#ctrl_panel_editor_btn_add_paragraph').on('click', (ev) => {
                ctrlPanelEditor.addParagraph();
            });
            $('#ctrl_panel_editor_btn_save').on('click', (ev) => {
                if (ctrlPanelEditor.get_name() != undefined) 
                    $("#save_control_panel_name").val(ctrlPanelEditor.get_name());
                else
                    $("#save_control_panel_name").attr("placeholder","Control panel's name comes here ...");
                $("#dlg_save_control_panel").modal("show");
            });
            $('#ctrl_panel_editor_btn_load').on('click', (ev) => {
                $("#dlg_select_a_ctrlpanel").modal("show");
            });

            $("#query_send").on("click", (ev) => {
                let s = $("#query").val();
                function h(ev) {
                    simcore_ws.removeEventListener("message", h);
                    let msg = JSON.parse(ev.data);
                    if (msg.ok) {
                        let s = cepsjson2txt(msg.sresult);
                        $("#query_results").append(
                        `<div class="alert alert-info fade in" role="alert">
                         <pre>${s}</pre>
                         </div>`
                        );
                    } else {

                    }
                }
                simcore_ws.addEventListener("message", h);
                simcore_ws.send("QUERY "+s);
            });

            if (!connected)
                setTimeout(() => {
                    $('#dlg_login').modal('show');
                }, 100);
        });
    </script>
</body>

</html>