<!DOCTYPE html>
<html lang=en>
<!-- 
    
    Cool effects

    https://blog.trackduck.com/2015/06/10/15-impressive-pop-animation-effects-codepen/
    
    
    -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="(c) ceps technologies, all rights reserved">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="jquery-ui/jquery-ui.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- link href="datatables/css/dataTables.material.min.css" rel="stylesheet" -->
    <!-- link href="datatables/css/jquery.dataTables.min.css" rel="stylesheet" -->
    <link href="datatables/css/dataTables.bootstrap.min.css" rel="stylesheet" >
    <link href="datatables-responsive/dataTables.responsive.css" rel="stylesheet">
    <link href="cepscloud-ui/cepscloud-ui.css" rel="stylesheet">
    <link href="animate/animate.css" rel="stylesheet">
    <style>
    </style>
    <title>MediaMarktSaturn - Rollouts</title>
</head>

<script>
    var global_observer_handlers = [];

    function register_observer(name, fn) {
        for (let e of global_observer_handlers)
            if (e.name == name) { e.handler = fn; return; }
        if (fn == undefined) return;
        for (let e of global_observer_handlers)
            if (e.handler == undefined) { e.name = name; e.handler = fn; return; }

        global_observer_handlers.push({name:name, handler:fn});
    }

    function unregister_observer(name) { register_observer(name, undefined); }

    function set_page_title(s) {
        $("#page_title").html(s);
    }

    function warn(s) {
        $.notify({/* options*/message: s
        },
            {/*settings*/ delay: 10000, type: 'warning', showProgressbar: false,
                animate: { enter: 'animated zoomInDown', exit: 'animated zoomOutUp' }
            }
        );        
    }

    function limit_to_n_characters(s, n) {
        if (s.length < n) return s;
        return s.substr(0, n) + "...";
    }
</script>


<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">MediaMarktSaturn<sup>Rollouts</sup></a>
    </nav>
    <div class="row">
        <div class="col-xs-6 col-sm-12">
            <h2><span id="page_title"></span></h2>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-2 col-sm-2"></div>
        <div class="col-xs-6 col-sm-8" >
                        <div class="form-group" style="padding-left: 4px;padding-right: 4px;">
                            <label for="search_statemachines"></label>
                            <input type="text" 
                                   class="form-control" 
                                   id="input_search_statemachines" 
                                   aria-describedby="search_statemachinesHelp" placeholder="Search">
                            <small id="search_statemachinesHelp" class="form-text text-muted"></small>
                          </div>
        </div>
        <div class="col-xs-2 col-sm-2"></div>        
    </div>

        <div class="row">
                <div class="col-xs-2 col-sm-2">
                    <table width="100%" >
                        <tr><td></td><td style="text-align:center;">Inactive/Ready</td></tr>
                        <tr><td style="width:4px;"></td><td style="border-top: 8px; border-top-color: grey;border-top-style: solid;"></td></tr>
                    </table>
                        <div id="toplevel_sms_inactive" ></div>
                </div>
                <div class="col-xs-2 col-sm-2">
                        <table width="100%">
                                <tr><td style="text-align:center;">Active</td></tr>
                                <tr><td style="border-top: 8px; border-top-color:darkslateblue;border-top-style: solid;"></td></tr>
                        </table>                            
                        <div id="toplevel_sms" ></div>
                </div>
                <div class="col-xs-2 col-sm-2">
                    <table width="100%">
                            <tr><td style="text-align:center;">Warning</td><td></td></tr>
                            <tr><td style="border-top: 8px; border-top-color:yellow;border-top-style: solid;"></td><td style="width:4px;"></td></tr>
                            </table>
                    <div id="toplevel_sms_in_warn_state"></div>
                </div>
            
                <div class="col-xs-2 col-sm-2">
                        <table width="100%">
                                <tr><td style="text-align:center;">Failure</td><td></td></tr>
                                <tr><td style="border-top: 8px; border-top-color:red;border-top-style: solid;"></td><td style="width:4px;"></td></tr>
                                </table>
                        <div id="toplevel_sms_in_error_state"></div>
                </div>
                <div class="col-xs-2 col-sm-2">
                    <table width="100%">
                            <tr><td style="text-align:center;">Done</td><td style="width:4px;"></td></tr>
                            <tr><td style="border-top: 8px; border-top-color:green;border-top-style: solid;"></td><td style="width:4px;"></td></tr>
                    </table>                            
                    <div id="toplevel_sms_in_final_state" ></div>
                </div>
                <div class="col-xs-2 col-sm-2">
                </div>

            </div>
        

    <!---------------------------- COMPONENT: Login ---------------------------->
    <div class="modal fade" id="dlg_login" tabindex="-1" role="dialog" aria-labelledby="dlg_login" style="z-index: 10000;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Connect</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-log-in"></i></span>
                        <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                        <input id="sim_url" type="text" class="form-control" name="user" value="localhost:1063" placeholder="">
                    </div>                      
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary" onclick="login($('#sim_url').val());">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Login ---------------------------->





 

    <!---------------------------- COMPONENT: Choose Signal ---------------------------->
    <div class="modal fade" id="dlg_select_a_signal" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_signal_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Choose a Signal</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <table id="dlg_select_a_signal_table" class="table table-striped table-bordered" width="100%"></table>

                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Signal ---------------------------->


    <!---------------------------- COMPONENT: Choose Event ---------------------------->
        <div class="modal fade" id="dlg_select_an_event" tabindex="-1" role="dialog" aria-labelledby="dlg_select_an_event_label" style="z-index: 10000;">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="dlg_select_an_event_label">Choose an Event</h4>
                    </div>
                    <div id="dlg_select_an_event_body" class="modal-body">
                        <table id="dlg_select_an_event_table" class="table table-striped table-bordered" width="100%"></table>
                    </div>
                    <div class="modal-footer">
                        <button id="dlg_select_an_event_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    <!---------------------------- COMPONENT: Choose Event ---------------------------->


    <!---------------------------- COMPONENT: Choose Simulation ---------------------------->
    <div class="modal fade" id="dlg_select_a_simulation" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_simulation_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_simulation_label">Choose a Simulation</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <table id="dlg_select_a_simulation_table" class="table table-striped table-bordered" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Simulation ---------------------------->


    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
    <div class="modal fade" id="dlg_select_a_ctrlpanel" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_ctrlpanel_label" style="z-index: 10000;">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_ctrlpanel_label">Choose a Control Panel</h4>
                </div>
                <div id="dlg_select_a_ctrlpanel_body" class="modal-body">
                    <table id="dlg_select_a_ctrlpanel_table" class="table table-striped table-bordered" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_ctrlpanel_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                 </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
       
    <!---------------------------- COMPONENT: Save Control Panel ---------------------------->
        <div class="modal fade" id="dlg_save_control_panel" tabindex="-1" role="dialog" aria-labelledby="dlg_save_control_panel" style="z-index: 10000;">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="dlg_save_control_panel_label">Save Control Panel</h4>
                    </div>
                    <div id="dlg_save_control_panel_body" class="modal-body">
                        <div class="form-group">
                            <label for="save_control_panel_name">Name</label>
                            <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                            <input id="save_control_panel_name" type="text" class="form-control" name="save_control_panel_name" value="" placeholder="">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary" onclick="$('#dlg_save_control_panel').modal('hide');save_active_control_panel($('#save_control_panel_name').val());">Ok</button>
                    </div>
                </div>
            </div>
        </div>
     <!---------------------------- COMPONENT: Save Control Panel ---------------------------->




    <script src="jquery/js/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="jquery-ui/jquery-ui.min.js"></script>
    <script src="datatables/js/jquery.dataTables.min.js"></script>
    <script src="datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script src="datatables-responsive/dataTables.responsive.js"></script>
    <script src="chartjs/Chart.js"></script>
    <script src="bootstrap-notify/bootstrap-notify.js"></script>
    <script src="cepscloud-ui/widget_properties_panel.js"></script>
    <script src="cepscloud-ui/widget_toggle_signal.js"></script>
    <script src="cepscloud-ui/widget_plot_signal.js"></script>
    <script src="cepscloud-ui/persistence.js"></script>
    <script src="d3/d3.js"></script>

    <script>
        let ctrlPanelEditor = undefined;
        let partitions = [];
        let constraints = [];
    </script>

    <!---------------------- Persistence --------------------- -->

    <script>
        let ctrlpanel_infos = [];
        let dlg_select_a_ctrlpanel_table = undefined;

        function set_ctrlpanel_infos(l) {
            if (l.length == 0) {
                    ctrlpanel_infos = []; return;
            }
            ctrlpanel_infos = new Array(l.length);
            for (let i = 0; i != l.length; ++i) {
                    ctrlpanel_infos[i] = l[i];
                ctrlpanel_infos[i].id = i;
            }
        }

        function get_ctrlpanel_infos() {
            return ctrlpanel_infos;
        }

        function ctrlpanel_info_get_name(ctrlpanel) {
            for (let e of ctrlpanel.content) {
                if (e.type != "struct" || e.name != "name" || e.content.length != 1) continue;
                return e.content[0];
            }
            return undefined;
        }

        function ctrlpanel_info_get_widget_property(e,n) {
            for (let ee of e.content) {
                if (ee.type == "struct" && ee.name == n) return ee.content;
            }
            return undefined;
        }

        function widget_descr_extract_type(widget_descr_type_prop) {
            if (widget_descr_type_prop.length == 0) return undefined;
            return widget_descr_type_prop[0];
        }

        function widget_descr_extract_assoc_sysstate(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            if (e[0].type == "symbol" && e[0].kind == "Systemstate") return e[0].name;
            return undefined;
        }

        function widget_descr_extract_assoc_event(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            if (e[0].type == "symbol" && e[0].kind == "Event") return e[0].name;
            return undefined;
        }

        function widget_descr_extract_style(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            let r = {};
            for (let ee of e) {
                if (ee.type != "struct") continue;
                if (ee.name == "height") r.height = ee.content[0];
                else if (ee.name == "width") r.width = ee.content[0];
            }
            return r;
        }

        function ctrlpanel_info_get_widget_descr(e) {
            
            if (e.type != undefined && e.type == "struct" && e.name == "widget") {
                try {
                    let t = undefined;                   
                    return [true, {
                        type: (t = ctrlpanel_info_get_widget_property(e, "type")) != undefined ? widget_descr_extract_type(t) : undefined,
                        associated_systemstate: (t = ctrlpanel_info_get_widget_property(e, "associated_systemstate")) != undefined ? widget_descr_extract_assoc_sysstate(t) : undefined,
                        associated_event: (t = ctrlpanel_info_get_widget_property(e, "associated_event")) != undefined ? widget_descr_extract_assoc_event(t) : undefined,
                        style: (t = ctrlpanel_info_get_widget_property(e, "style")) != undefined ? widget_descr_extract_style(t) : undefined
                    }];
                } catch (error) {
                    
                }
            }
            return [false];
        }




        function ctrlpanel_dlg_decorate_ctrlpanel_table_entry(e,pnl_info) {
            return "<a href='#' onclick='load_ctrlpanel_given_id(" + pnl_info.id+");'>" + e + "</a>";
        }

        function choose_ctrlpanel_dlg() {
                    let data = [];
            columns = [{title: "Name" }];
            //["<a href='#' onclick='handle_signal_select(\"" + sig.name + "\");'>" + sig.name + "</a>", sig.comment]
            get_ctrlpanel_infos().forEach((elem) => {
                    let t = ctrlpanel_info_get_name(elem);
                if (t == undefined) data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry("<i>No Title</i>", elem)]);
                else data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry(t, elem)]);
            })

            dlg_select_a_ctrlpanel_table = $('#dlg_select_a_ctrlpanel_table').DataTable({
                    select: {
                    style: 'single'
                },
                data: data,
                columns: columns
            });
            $("#dlg_select_a_ctrlpanel").modal("show");
        }

        function load_ctrlpanel_given_id(id) {
            $("#dlg_select_a_ctrlpanel").modal("hide");
            let cpnl_info = undefined;
            for (let e of ctrlpanel_infos) {
                if (e.id == id) {
                    cpnl_info = e;
                    break;
                }
            }
            if (cpnl_info == undefined) return;
            build_ctrlpanel_from_json(ctrlPanelEditor, cpnl_info);
        }
    </script>


    <!---------------------- Persistence -------------------- -->

    <!---------------------- Signals --------------------- -->
    <script>
        function Signalinfo(n, v, tv, c, s, r, f, i) {
            this.name = n;
            this.value = v;
            this.target_value = tv;
            this.comment = c;
            this.sender = s;
            this.receiver = r;
            this.frames = f;
            this.info = i;
            this.observed_min = undefined;
            this.observed_max = undefined;
            this.target_value_changed = false;
        }

        function Eventinfo(n) {
            this.name = n;
        }

        var signals = [];
        var signals_dt = undefined;
        var simcore_events = [];
        var simcore_events_dt = undefined;
    </script>
    <!---------------------- Signals --------------------- -->
    
    
    

    <script>
        var dlg_select_a_signal_table_dataset = [];        

        var dlg_select_a_signal_table_columns = [
            { title: "Name" },
            { title: "Comment" },
        ];

        var dlg_select_an_event_table_dataset = [];

        var dlg_select_an_event_table_columns = [
            { title: "Name" }
        ];

        const slider_granularity_default = 4096;

        function generate_test_data() {
            signals = [
                new Signalinfo("Signal A", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], {type:"float",min:-2,max:2}),
                new Signalinfo("Signal B", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10 }),
                new Signalinfo("Signal C", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal D", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal E", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val:1, name: "b" }, { val:2, name:"c" }] }),
                new Signalinfo("Signal F", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal G", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal H", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal I", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal J", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal K", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal L", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal M", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal N", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal O", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal P", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal Q", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal R", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal S", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal T", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal U", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal V", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal W", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal X", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" })
            ];
        }

        function set_signal_target_value(widget_id, tv, signal_name) {            
            let sig = get_signal_by_name(signal_name);
            sig.target_value = tv;
            sig.target_value_changed = true;
            for (let e of widget_infos) {
                if (e.id == widget_id) continue;             
                if (e.info.type.sig && e.info.toggle_sig && (e.info.sig_name == signal_name) ) {
                    e.ext.set_value(tv);
                }
            }
            if (simcore_ws && connected) setTimeout(
                () => {
                    let cmd = "SET_VALUE_NO_REPLY";
                    cmd += " " + sig.name;
                    if (sig.info.type == "float") cmd += " number";
                    else cmd += " int";
                    cmd += " " + sig.target_value.toString();
                    sig.target_value_changed = false;                    
                    simcore_ws.send(cmd);
                }, 0
            );
        }

        function map_sig_target_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2,31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31))+1;
        
            d = (mx - mn);
            if (d == 0) return 0;
            let rr = ((signal.target_value - mn) / d) * r;
            return rr;
        }

        function map_sig_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((signal.value - mn) / (d)) * r;
            return rr;
        }

        function map_range_index_to_value(signal, r, i) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((i / r) * d) + mn;
            if (signal.info.type == "float")
                return Math.round(rr * 10000) / 10000.0;
            if (signal.info.type == "int") {
                rr = Math.min(Math.round(rr), signal.info.max);
                if (rr < signal.info.min) rr = signal.info.min;
                return rr;
            }
            else return rr;
        }

        //generate_test_data();

        function get_signal_by_name(n) {
            for (let e of signals) if (e.name == n) return e;
            return undefined;
        }

        function apply_constraints_to_signals(constraints) {
            for (let expr of constraints) {
                if (expr.type == "binop") {
                    let lhs = expr.left;
                    let rhs = expr.right;
                    if (expr.name == "<=") { expr.name = ">="; let t = rhs; rhs = lhs; lhs = t; }
                    if (expr.name == "<") { expr.name = ">"; let t = rhs; rhs = lhs; lhs = t; }
                    if (lhs.type == "symbol" && lhs.kind == "Systemstate") {
                        sig = get_signal_by_name(lhs.name); if (sig == undefined) continue;
                        if (expr.name == ">=" || expr.name == ">") {
                            let t = sig.info.min;
                            if (sig.info.min != undefined) sig.info.min = Math.max(sig.info.min, rhs);
                            else sig.info.min = rhs;
                            if (sig.info.min == undefined) sig.info.min = t;
                        }
                    } else if (rhs.type == "symbol" && rhs.kind == "Systemstate") {
                        sig = get_signal_by_name(rhs.name); if (sig == undefined) continue;
                        if (expr.name == ">=" || expr.name == ">"){
                            let t = sig.info.max;
                            if (sig.info.max != undefined) sig.info.max = Math.min(sig.max, lhs);
                            else sig.info.max = lhs;
                            if (sig.info.max == undefined) sig.info.max = t;
                        }
                    }
                }
            }
        }

        function apply_partitions_to_signals(partitions) {
            function get_signal(cont) {
                for (let e of cont) {
                    if (e.type == "struct" && e.name == "of") {
                        if (e.content[0].type != undefined && e.content[0].type == "symbol")
                            return get_signal_by_name(e.content[0].name);
                        return get_signal_by_name(e.content[0]);
                    }
                }
                return undefined;
            }
            for (let p of partitions) {
                let sig = get_signal(p.content);
                sig.info.vm = [];
                for (let e of p.content) {
                    if (e.type == "scope" && e.content.length > 1) {
                        let expr = e.content[0];
                        if (expr.type != "binop" || expr.name != "==") continue;
                        let lhs = expr.left;
                        let rhs = expr.right;
                        if (typeof lhs != "number")[lhs, rhs] = [rhs, lhs];
                        if (typeof lhs != "number") continue;
                        if (rhs.type != "symbol" || rhs.kind != "Systemstate" || rhs.name != sig.name) continue;
                        sig.info.vm.push({ val: lhs, name: e.content[1]});                      
                    }
                }
            }
        }
        
        function dlg_select_a_signal_populate_dataset(){
            ds = [];           
            for (let sig of signals) {               
                ds.push(["<a href='#' onclick='handle_signal_select(\"" + sig.name+"\");'>"+sig.name+"</a>",sig.comment]);
            }
            return ds;            
        }
        function dlg_select_an_event_populate_dataset() {
            ds = [];
            for (let ev of simcore_events) {
                ds.push(["<a href='#' onclick='handle_event_select(\"" + ev.name + "\");'>" + ev.name + "</a>"]);
            }
            return ds;
        }

        function Widget(id) { this.type_ = "undefined"; }
        Widget.prototype.type = function () { return this.type_; }
        Widget.prototype.set_type = function (t) { this.type_ = t; }

        function dlg_set_widget_type_get_results() {
            return {
                toggle_signal: $("#dlg_set_widget_type_r1").is(":checked"),
                show_signal: $("#dlg_set_widget_type_r2").is(":checked"),
                plot_signal: $("#dlg_set_widget_type_r3").is(":checked"),
                trigger_event: $("#dlg_set_widget_type_r4").is(":checked"),
                run_script: $("#dlg_set_widget_type_r5").is(":checked")
            };
        }

        function helper_make_toggle_widget_sel_list(signal,v) {
            let l = ["- No Mapping Available -"];
            let sel_index = 0;
            let i = 1;
            for (e of signal.info.vm) {
                l.push(e.name);
                if (Math.abs(v) < Number.MIN_VALUE)
                { if (Math.abs(v - e.val) <= Number.MIN_VALUE) sel_index = i; }
                else
                { if (Math.abs(v - e.val) / Math.abs(v) <= Number.MIN_VALUE) sel_index = i; }
                ++i;
            }
            return [l,sel_index];
        }

        function helper_display_unit_and_format(unit, format){
            let r = "";
            if (unit == undefined || unit.length == 0) r += "scalar"; else r += unit;
            if (format == "Hexadecimal") r += " <small>( hex. )</small>";
            else if (format == "Octal") r += " <small>( oct. )</small>";
            else if (format == "Binary") r += " <small>( bin. )</small>";
            else r += " <small>( dec. )</small>";
            return r;
        }

        function helper_make_widget_content_with_loader() {
            
            return `<table width="100%" valign="center">
                     <tr>
                      <td width="70px"><div class="loader" style="float: left;"></div></td>
                      <td width="15px"></td><td align="left"><h4><span class="label label-default">Fetching Data</span></h4></td>
                     </tr>
                    </table>`;
        }
        function helper_make_trigger_event_widget_content(widget_id, ev_info,btn_title) {
            let widget_content =
                `<button type="button" class="btn btn-primary btn-block" id="${widget_id}_trigger_ev_btn">${btn_title}</button>`;
            return widget_content;
        }

        function helper_make_toggle_widget_content(widget_id, signal, watch) {
            if (watch == undefined) watch = false;
            let widget_content = "";
            if (signal.value == undefined) {
                widget_content = helper_make_widget_content_with_loader();                    
            }
            else {
                if (signal.info.vm != undefined && signal.info.vm.length > 0) {
                    let [l, sel_index] = helper_make_toggle_widget_sel_list(signal, signal.target_value);
                    widget_content =
                        `
                 <table width='100%'>
                  <tr>
                   <td width='50%'>
                     <div id='dummy_${widget_id}'></div>
                   </td>
                   <td width='50%'>
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                       <select id="${widget_id}_select_ctrl" class="form-control">
                          ${helper_build_sel_html(l, sel_index)}
                        </select>
                        <input type ="text" style="width:100%;" id="${widget_id}_text_ctrl" 
                               class="form-control" value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                               ${watch ? "disabled" : "enabled"}>
                        <span class="input-group-addon" >${helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>                        
                    </div>
                  </td>
                 </tr>
                </table>`;

                } else {
                    widget_content =
                        `
                <table width="100%">
                 <tr>
                  <td style="min-width:30px;width:50%;">
                   <div id='dummy_${widget_id}'></div>
                  </td>
                  <td style="min-width:160px;width:50%;"> 
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                    <input type ="text" style="width:100%;"
                           id="${widget_id}_text_ctrl" 
                           class="form-control"
                           value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                           ${watch ? "disabled" : "enabled"}>
                    <span class="input-group-addon" >${ helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>
                   </div>
                  </td>
                 </tr>
                </table>`;
                }
            }
            
            return widget_content;
        }

        function check_constraints(signal, v) {
            if (signal == undefined || signal.info == undefined) return [true];
            let mx = signal.info.max;
            let mn = signal.info.min;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;

            if (v < mn) return [false, "Too Small."];
            if (v > mx) return [false, "Too Big."];
            return [true];
        }

        function validate_input(signal, text, format) {
            let v = NaN;
            if (signal.info.type == "float") {
                v = parseFloat(text);
            } else if (signal.info.type == "int") {
                
                if (format == "Hexadecimal") {
                    if (text.match(/^(\-)?([0-9]|a|b|c|d|e|f)+$/)) v = parseInt(text, 16);
                } else if (format == "Octal") {
                    if (text.match(/^(\-)?([0-7])+$/))v = parseInt(text, 8);
                } else if (format == "Binary") {
                    if (text.match(/^(\-)?([0-1])+$/))v = parseInt(text, 2);
                } else {
                    if (text.match(/^(\-)?([0-9])+$/)) v = parseInt(text);
                }
            }
            if (!isNaN(v)) {
                let r = check_constraints(signal,v);
                if (!r[0]) return [r[0], v, r[1]];
            }

            return [!isNaN(v),v, text.length==0 ? "No Input" : "That's not a number"];
        }
        function sig_value_text_representation(signal, v, format) {
            if (signal.info.type == "int") {
                if (format == "Hexadecimal") return v.toString(16);
                else if (format == "Octal") return v.toString(8);
                else if (format == "Binary") return v.toString(2);                 
            }
            return v.toString();
        }
        
        function handle_widget_click_header(widget_id, ev) {
            
            event.preventDefault();
            $(".baseWidget-selected").removeClass("baseWidget-selected");
            let widget = $("#" + widget_id); 
            widget.addClass("baseWidget-selected");

            $("#widget_properties_panel").removeClass("prop-panel-transition-1");
            $("#widget_properties_panel").removeClass("prop-panel-transition-2");
            $("#widget_properties_panel").addClass("prop-panel-transition-2");

            update_prop_panel(widget);
            return false;
        }

        function CtrlPanelComponentTemplates() {
            this.id_counter = 0;
        }

        function close_widget(ev,widget_id) {
            ev.stopPropagation();
            $("#" + widget_id).addClass("baseWidget-remove");
            
            setTimeout(() => {
                $("#" + widget_id).remove();
            }, 500);
            return false;
        }

        CtrlPanelComponentTemplates.prototype.baseWidget = function () {
            this.id_counter++; 
            return [`widget_${this.id_counter}`,`<div id="widget_${this.id_counter}" class="baseWidget baseWidget-not-initialized">
                    <div id="header_of_widget_${this.id_counter}" class="header" onclick="handle_widget_click_header('widget_${this.id_counter}',event)"> 
                      <i>Click to configure...</i>
                      <button type="button" class="btn btn-xs close" aria-label="Close" onclick="close_widget(event,'widget_${this.id_counter}');" style="transform: translateY(-11px);">
                        <span aria-hidden="true" class="small" >&times;</span>
                      </button>
                    </div>
                    <div id="content_of_widget_${this.id_counter}" class="baseWidget-content"></div>
                    <div id="footer_of_widget_${this.id_counter}" class="baseWidget-footer"></div>   
                    </div>
                    </div>
                    `];
        }
        CtrlPanelComponentTemplates.prototype.paragraph = function () {
            return `<br>`;
        }

        function CtrlPanelEditor(ctrl_editor_component, widget_templates, name) {
            this.ctrl_editor_component_ = ctrl_editor_component;
            this.widget_templates_ = widget_templates;
            this.name = name;
        }
        CtrlPanelEditor.prototype.set_name = function (n) { this.name = n; if (n != undefined) set_page_title("Control Panel <strong>" + n + "</strong>"); else set_page_title("Control Panel <i style='color:red;'> - No Title - </i>");}
        CtrlPanelEditor.prototype.get_name = function () { return this.name; }
        CtrlPanelEditor.prototype.view = function () { return this.ctrl_editor_component_; }
        CtrlPanelEditor.prototype.clear = function () {
            widget_infos = [];
            $(this.ctrl_editor_component_).html("");
        }
        CtrlPanelEditor.prototype.widgetTemplates = function () { return this.widget_templates_; }
        CtrlPanelEditor.prototype.addWidget = function () {
            let r = this.widgetTemplates().baseWidget();
            this.ctrl_editor_component_.append(r[1]);
            return r[0];
        }
        CtrlPanelEditor.prototype.addParagraph = function () {
            this.ctrl_editor_component_.append(this.widgetTemplates().paragraph());
        }

       
    </script>



    <script>
        function traverse_ceps_as_json(doc, f) {
            if (doc === undefined) return true;
            if (Object.prototype.toString.call(doc) == "[object Array]") {
                for (let e of doc) {
                    if (!f(e)) return false;
                    if(!traverse_ceps_as_json(e, f)) return false;
                }
                return true;
            } else if (doc.content) {
                return(traverse_ceps_as_json(doc.content, f));
            }
            return f(doc);
        }

    </script>

    <script>
        var connected = false;
        var new_remote_site  = false;
        var remote_url = undefined;
        var simcore_ws = undefined;
        var global_sysstates = [];

        function get_simcore_ws_given_widget_id(widget_id) {
            return simcore_ws;
        }

        function simcore_ws_process_messages(ev) {
            let msg = JSON.parse(ev.data);
            if (!msg.ok) return;
            if (msg.signals) {
               for (let s of msg.signals) {
                   let sig = get_signal_by_name(s.name);
                   if (!sig) continue;
                   sig.value = s.value;
                   if (sig.target_value == undefined) sig.target_value = sig.value;
                   if (sig.observed_min == undefined || sig.observed_max == undefined) {
                       sig.observed_min = sig.value;
                       sig.observed_max = sig.value;
                   } else {
                       sig.observed_min = Math.min(sig.value, sig.observed_min);
                       sig.observed_max = Math.max(sig.value, sig.observed_max);
                   }


                   for (let wi of widget_infos) {
                       if (wi.info.type.sig && !wi.info.toggle_sig && (wi.info.sig_name == s.name)) {
                           if (wi.ext && wi.ext.set_value) wi.ext.set_value(sig.value);
                       }
                   }

               }
            }
        }

        function finish_prologue(ws) {
            ws.addEventListener("message", simcore_ws_process_messages);
            simcore_ws = ws;
            connected = true;
            if (new_remote_site) {
                if (get_ctrlpanel_infos().length) setTimeout(() => { choose_ctrlpanel_dlg(); }, 1000);
            }
        }

        function fetch_partitions(ws) {
            function h(m) {
                ws.removeEventListener("message", h);
                partitions = [];
                try {
                    let msg = JSON.parse(m.data);
                    if (msg.ok) {
                        partitions = msg.sresult;
                        apply_partitions_to_signals(partitions);
                    }
                } catch (err) { console.log(err);}
                finish_prologue(ws);
            }
            ws.send('QUERY root.as_identifier("partition");');
            ws.addEventListener("message", h);
        }

        function fetch_constraints(ws) {
            function h(m) {
                constraints = [];
                ws.removeEventListener("message", h);
                try {
                    let msg = JSON.parse(m.data);
                    if (msg.ok) {
                        constraints = msg.sresult;
                        apply_constraints_to_signals(constraints);
                    }
                } catch (err) { console.log(err); }
                fetch_partitions(ws);
            }
            ws.send("QUERY root.constraints.content();");
            ws.addEventListener("message", h);
        }

        function fetch_frames_from_simcore(ws) {

            $.notify({/* options*/message: 'Connected with \'' + remote_url + `'` },
                {/*settings*/ type: 'success', showProgressbar: false, delay: 2000,
                    animate: { enter: 'animated rollIn', exit: 'animated rollOut' }
                }
            );

            ws.send("QUERY root.frame;");
            function process_ctrlpanels_resultset(ev) {
                let msg = JSON.parse(ev.data);
                if (msg.ok) {
                    set_ctrlpanel_infos(msg.sresult);
                }
                ws.removeEventListener("message", process_ctrlpanels_resultset);
                fetch_constraints(ws);
                //finish_prologue(ws);
            }
            function process_frames_resultset(ev) {
                let msg = JSON.parse(ev.data);
                //console.log(msg);
                if (msg.ok) {
                    ws.removeEventListener("message", process_frames_resultset);
                    let set_of_signals = new Set();
                    traverse_ceps_as_json(msg.sresult, (entry) => {
                        if (entry.type != undefined) if (entry.type == "symbol" && entry.kind == "Systemstate") {
                            set_of_signals.add(entry.name);
                        }
                        return true;
                    });
                    let list_of_signals = Array.from(set_of_signals).sort();
                    for (let s_name of list_of_signals) {
                        signals.push(new Signalinfo(s_name, undefined, undefined, /*comment*/"",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: undefined, max: undefined }));
                    }
                    traverse_ceps_as_json(msg.sresult, (entry) => {
                        if (entry.type != undefined && entry.type == "struct" && entry.name == "comment") {
                            for (let e of entry.content) {
                                if (e.type == undefined || e.type != "struct" || e.name != "sig") continue;
                                let sig = undefined;
                                let comment = undefined;
                                for (let ee of e.content) {
                                    if (ee.type == undefined || ee.type != "struct") continue;
                                    if (ee.name == "name") sig = get_signal_by_name(ee.content[0]);
                                    else if (ee.name == "comment") comment = ee.content[0];
                                }
                                if (comment != undefined && sig != undefined)
                                    sig.comment = comment;
                            }
                            return false;
                        }
                        return true;
                    });

                    for (let e of signals) {
                        for (let ee of global_sysstates) {
                            if (e.name != ee.name) continue;
                            if (ee.type == "int") e.info.type = "int";
                            else if (ee.type == "float") e.info.type = "float";
                            break;
                        }
                    }
                    ws.addEventListener("message", process_ctrlpanels_resultset);
                    ws.send("QUERY root.ctrlpanels.content();");
                }
            };

            ws.addEventListener("message", process_frames_resultset );
        }

        var dlg_select_a_simulation_table_data = undefined;

        function connect_to_simcore(url) {
            main_socket.removeEventListener("open", on_ws_initial_connect);
            main_socket.removeEventListener("close", on_ws_close);
            main_socket.removeEventListener("error", on_ws_error);
            do_login(url);
        }
//  +#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!+#!
//Here comes the new stuff
//
//
//
        let DEBUG_GUI_EVENTS = false;

        function simplifyceps2json(o,m){

            function is_attr(e){
                if (e.type == "struct" && e.content.length == 1 && e.content[0].type == undefined) return true;
                return false;
            }

            if (m.content == undefined){
                if (m.type == "binop"){
                    
                }
            } else for(let i = 0; i != m.content.length;++i){
                let e = m.content[i];
                if (!is_attr(e)){
                    let field = e.name;
                    if (o[field] == undefined) o[field] = [];
                    let t = {};
                    simplifyceps2json(t,e);
                    o[field].push(t);
                } else {
                    o[e.name]  = e.content[0];
                }
            }
        }


        let states_info = {
            /*
            states : [{
                       full_name:"fullqualified state id, e.g. a.b.c.d", 
                       svg_id:"Technical Id of this state's svg representation",
                       idx : "Numerical id"
                      }
                     ],
            states_per_sm : {
                sm1 : [1,2,3],
                sm2 : [4,5,6]
            }
            */
            
        };
        let callback_proc_consumer = function () {};
        let svgs = [];
        let consumed_events = {};
        let layout_info = {
            sm_widget_tile : {width:156, height:73,outter_width:160, outter_height:100},
            sm_minimized : {width:166, height:23,outter_width:120, outter_height:40}
        };

        let components = {};

        function find_sm_node_id_by_idx(idx){
            for(let i = 0; i!=states_info.states.length;++i){
                let e = states_info.states[i];
                if (e.idx == idx) return e.svg_id;
            }

            return undefined;
        }

        function get_svg_infos(name){
            for(let i = 0; i != svgs.length;++i)
             if (svgs[i].name == name) return svgs[i];
            return undefined;
        }

        function gui_action_shrink_to_tile_sm_view(sm_name,btn){
            if (DEBUG_GUI_EVENTS) console.log("function gui_action_shrink_to_tile_sm_view(sm_name,btn)");
            btn.removeClass("cepscloud-ui-btn-tile");
            btn.addClass("cepscloud-ui-btn-expand");
            let sm = get_svg_infos(sm_name);

            $(`#sm_viz_${sm_name}`).css("height",`${layout_info.sm_widget_tile.outter_height}px`);
            $(`#sm_viz_${sm_name}`).css("width",`${layout_info.sm_widget_tile.outter_width}px`);
            $(`#sm_viz_container_${sm_name}`).css("height",`${layout_info.sm_widget_tile.height}px`);
            $(`#sm_viz_container_${sm_name}`).css("width",`${layout_info.sm_widget_tile.width}px`);
            $(`#sm_viz_container_parent_div_${sm_name}`).css("height",`${layout_info.sm_widget_tile.height}px`);
            $(`#sm_viz_container_parent_div_${sm_name}`).css("width",`${layout_info.sm_widget_tile.width}px`);
            d3_util_scale(d3.select(`#sm_viz_${sm_name}`).select("svg").select("g"),sm.tile_scale,sm.tile_scale);
            $(`#sm_viz_${sm_name}`).addClass("ceps-ui-tile");
            $(`#btn_glyph_${sm_name}_view_size`).removeClass("glyphicon-minus");
            $(`#btn_glyph_${sm_name}_view_size`).addClass("glyphicon-fullscreen");
        }

        function gui_action_expand_sm_view(sm_name,btn){
            if (DEBUG_GUI_EVENTS) console.log("function gui_action_expand_sm_view(sm_name,btn)");
            btn.removeClass("cepscloud-ui-btn-expand");
            btn.addClass("cepscloud-ui-btn-tile");
            let sm = get_svg_infos(sm_name);
            $(`#sm_viz_${sm_name}`).css("height",`${sm.svg_orig_height+40}px`);
            $(`#sm_viz_${sm_name}`).css("width",`${sm.svg_orig_width+10}px`);
            $(`#sm_viz_container_${sm_name}`).css("height",`${sm.svg_orig_height}px`);
            $(`#sm_viz_container_${sm_name}`).css("width",`${sm.svg_orig_width}px`);
            $(`#sm_viz_container_parent_div_${sm_name}`).css("height",`${sm.svg_orig_height}px`);
            $(`#sm_viz_container_parent_div_${sm_name}`).css("width",`${sm.svg_orig_width}px`);
            d3_util_scale(d3.select(`#sm_viz_${sm_name}`).select("svg").select("g"),1,1);
            $(`#sm_viz_${sm_name}`).removeClass("ceps-ui-tile");
            $(`#btn_glyph_${sm_name}_view_size`).removeClass("glyphicon-fullscreen");
            $(`#btn_glyph_${sm_name}_view_size`).addClass("glyphicon-minus");
        }

        function gui_action_toggle_sm_view(sm_name){
            if (DEBUG_GUI_EVENTS) console.log("function gui_action_toggle_sm_view(sm_name)");
            let btn = $(`#btn_${sm_name}_view_size`);
            if (btn.hasClass("cepscloud-ui-btn-expand"))
             gui_action_expand_sm_view(sm_name,btn);
            else
             gui_action_shrink_to_tile_sm_view(sm_name,btn);
        }

        function gui_action_move_one_down_sm_view(sm_name){
            let e = $(`#sm_viz_${sm_name}`);
            let p = e.parent();//.css("background-color","red");
            let n = e.next();
            //if(n.empty()) return;
            e.remove();
            e.insertAfter(n);
            console.log(p);
        }

        function change_lane_of_sm_view(sm_name,current_lane,new_lane){
            states_info.lane[sm_name] = new_lane;
            let e = $(`#sm_viz_${sm_name}`);
            e.remove();
            $(new_lane).append(e);
        }



        function update_info_cards(){
            $(".ceps-ui-minimized").each( function(idx){
                let sm_name = $(this).attr("sm-name");
                let coverage = states_info.coverage[sm_name];
                if (coverage == undefined){

                } else {
                    let percentage = Math.round(100.0 * coverage);
                    //console.log(percentage);
                    $(`#sm_viz_progress_${sm_name}`).css("width",`${percentage}%`);
                    $(`#sm_viz_progress_${sm_name}_info_text`).html(`${percentage}%`);
                }
             }
            );
        }
        
        function update_gui(){
            update_info_cards();
        }



        function html_gen_sm_widget(title,content,as_tile,minimized) {
            if (as_tile){
               return `    
               <div class="panel panel-primary sm_viz ceps-ui-tile" id="sm_viz_${title}" 
                    style="margin:2px;width:${layout_info.sm_widget_tile.outter_width}px;height:${layout_info.sm_widget_tile.outter_height}px;float:left;">
                    
                    <div class="panel-heading" style="height:24px;padding:0px;padding-left:5px;" >
                    ${title}
                    <button type="button" 
                            class="btn btn-default btn-xs pull-right cepscloud-ui-menu-btn cepscloud-ui-btn-expand" 
                            style= "padding-top:2px;border-width:0px;outline:none;background-color:transparent;"
                            onclick="gui_action_toggle_sm_view('${title}');"
                            id="btn_${title}_view_size"
                            >
                        <span id="btn_glyph_${title}_view_size" class="glyphicon glyphicon-fullscreen"></span>
                    </button>
                    <button type="button" 
                            class="btn btn-default btn-xs pull-right cepscloud-ui-menu-btn" 
                            style= "padding-top:2px;border-width:0px;outline:none;background-color:transparent;"
                            onclick="gui_action_move_one_down_sm_view('${title}');"
                            id="btn_${title}_view_move_one_down"
                            >
                        <span id="btn_glyph_${title}_view_move_one_down" class="glyphicon glyphicon-chevron-right"></span>
                    </button>
                    <button type="button" 
                            class="btn btn-default btn-xs pull-right cepscloud-ui-menu-btn" 
                            style= "padding-top:2px;border-width:0px;outline:none;background-color:transparent;"
                            onclick="gui_action_move_one_up_sm_view('${title}');"
                            id="btn_${title}_view_move_one_up"
                            >
                        <span id="btn_glyph_${title}_view_move_one_down" class="glyphicon glyphicon-chevron-left"></span>
                    </button>

                    </div>
                    <div class="panel-body" 
                                 id="sm_viz_container_parent_div_${title}"
                                 style="padding-left:2px;overflow:hidden;width:${layout_info.sm_widget_tile.width}px;height:${layout_info.sm_widget_tile.height}px;">
                            <div id="sm_viz_container_${title}" style="position:relative;">${content}</div>
                     </div>
               </div>`;
                        
            }
            if (minimized){

                content =`
<table style="width:100%;">
<tr><td style="vertical-align:top;width:100px;" >${title}</td><td style="height:16px;">
<div class="progress">
  <div style="width:0%;" 
       id="sm_viz_progress_${title}" 
       class="progress-bar progress-bar-striped active" 
       role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" >
       <span id="sm_viz_progress_${title}_info_text"></span>
  </div>
</div></td></tr></table>
                `;

                return `    
               <div id="sm_viz_${title}" style="padding:2px;" class="sm_viz ceps-ui-minimized" sm-name="${title}" >
                    
                            ${content}
               </div>`;
                
            }
            return `    <div class="panel panel-primary sm_viz" id="sm_viz_${title}" >
                            <div class="panel-heading">${title}</div>
                            <div class="panel-body">${content}</div>
                        </div>`;
        }

        function mark_active_nodes(v){
            //d3.selectAll(["#node1_is_Step1","#node1_is_Step2"]).style("fill","green").style("stroke","green");
            //console.log(v);
            for(let i = 0; i != v.length;++i){
                let node_id = find_sm_node_id_by_idx(v[i]);
                //console.log(node_id);
                d3.select(`#${node_id}`).style("fill","green").style("stroke","green");
            }
        }

        

        function get_sm(idx){
            if (states_info.states == undefined) return;
            let sinfo = undefined;
            for (let i = 0; i!=states_info.states.length;++i){
                if (states_info.states[i].idx == idx) {sinfo = states_info.states[i];break;}
            }
            if (sinfo == undefined) {                
                return undefined;
            }
            let full_name = sinfo.full_name;
            if(sinfo.svg_id.startsWith("cluster")) return full_name;
            return full_name.substring(0,full_name.lastIndexOf("."));
        }

        function get_sms_with_changes(old_states,new_states){
            sms_changed = {};
            //INVARIANT old_states,new_states are already sorted(in ascending order) integer arrays
            if (old_states.length == 0 && new_states.length == 0) return; //nothing todo here
            if (new_states.length == 0 || old_states.length == 0){
                let v = new_states;
                if (new_states.length == 0) v = old_states;
                for(let i = 0; i != v.length; ++i){
                    sms_changed[get_sm(v[i])] = 1;
                }
            }
            //console.log(old_states);
            let v1 = old_states;
            let v2 = new_states;
            let j = 0;let i = 0;
            for(; i != v1.length && j != v2.length;++i){
                if (v1[i] == v2[j]) ++j;
                else if (v1[i] < v2[j]) sms_changed[get_sm(v1[i])] = 1;
                else /*v1[i] > v2[j]*/ {++j;--i;}
            }
            if (i < v1.length) {
                for(; i != v1.length;++i) sms_changed[get_sm(v1[i])] = 1;
            }
            v2 = old_states;
            v1 = new_states;
            j = 0;i = 0;
            for(; i != v1.length && j != v2.length;++i){
                if (v1[i] == v2[j]) ++j;
                else if (v1[i] < v2[j]) sms_changed[get_sm(v1[i])] = 1;
                else /*v1[i] > v2[j]*/ {++j;--i;}
            }
            if (i < v1.length) {
                for(; i != v1.length;++i) sms_changed[get_sm(v1[i])] = 1;
            }        
            return sms_changed;
        }

        function start_ceps_proc_consumer(ws){
            function h(ev){
                
                let msg = JSON.parse(ev.data);
                let to = {};
                simplifyceps2json(to,msg.sresult.coverage);
                msg.sresult.coverage = to.coverage[0];
                //console.log(msg.sresult.coverage    );
                states_info["coverage"] = msg.sresult.coverage.transition_coverage[0].toplevel_state_machines[0];
                //console.log(states_info.coverage);

                if (states_info.active_states != undefined) {

                    let sms_changed = get_sms_with_changes(states_info.active_states,msg.sresult.current_states);

                    for(let sm in sms_changed){
                        let new_lane = get_sm_lane(sm,msg.sresult.current_states);
                        
                        if (new_lane != states_info.lane[sm])
                         change_lane_of_sm_view(sm,states_info.lane[sm],new_lane);    
                        states_info.lane[sm] = new_lane;                    
                    }
                   
                }
                states_info.active_states = msg.sresult.current_states;
                callback_proc_consumer();                       
            }
            ws.addEventListener("message", h);
            setInterval(
                function () {
                 ws.send("QUERY root.__proc.current_states_with_coverage");                       
                }, 200);            
        }

        function on_change_input_search_statemachines(){          
            let s = $("#input_search_statemachines").val().split(" ");
            let search_empty = true;
            let r = {};
            for(let i = 0; i != s.length; ++i){
                if (s[i].length == 0) continue;
                search_empty = false;
                for(let j = 0; j!=states_info.states.length;++j) {
                    let e = states_info.states[j];
                    if (e.full_name.indexOf(s[i]) == -1) continue;
                    let ss = e.full_name.split(".");
                    r[ss[0]] = 1;                    
                }
            }
            if (search_empty){
                for(let i = 0; i != svgs.length; ++i ) 
                    $(`#sm_viz_${svgs[i].name}`).css("display","inline");
                return;
            }
            for(let i = 0; i != svgs.length;++i) svgs[i].matched = false;

            for(let e in r){
                for(let i = 0; i != svgs.length;++i){ 
                 if (svgs[i].name == e){
                    svgs[i].matched = true;
                    //console.log("makevisible:"+e);
                    $(`#sm_viz_${e}`).css("display","inline");
                 }
                }
            }
            for(let i = 0; i != svgs.length;++i) if (!svgs[i].matched) $(`#sm_viz_${svgs[i].name}`).css("display","none");
        }

        function compute_consumed_events(sm){
            let t = {};
            if (sm.content == undefined) return t;
            for(let i = 0; i != sm.content.length;++i){
                let e = sm.content[i];
                if (e.name != "t" || e.type != "struct") {
                    let tt = compute_consumed_events(e);
                    for(let k in tt) t[k] = tt[k];
                    continue;
                }
                for (let j = 0; j!=e.content.length;++j)
                  if(e.content[j].type == "symbol" && e.content[j].kind == "Event")
                   t[e.content[j].name] = 1;
            }
            return t;
        }

        function id_of_sm(sm_struct){
            if (sm_struct.content.length > 0 && sm_struct.content[0].type == undefined) return sm_struct.content[0];
            return undefined
        }

        function set_svg_transform_attr(transform_attr,what,param){
            let a = [];
            let last_pos = 0;
            for(let i = 0;i < transform_attr.length;++i){
                if (transform_attr.charAt(i) == ")"){
                    a.push(transform_attr.substring(last_pos,i+1));
                    let j = i+1;
                    for(;j != transform_attr.length && transform_attr.charAt(j) == " ";++j);
                    last_pos = j;
                    i = last_pos;
                }
            }
            let found = false;
            for(let i = 0; i != a.length;++i){
                if (!a[i].startsWith(what)) continue;
                a[i] = what+param;
                found = true;
            }
            if (!found) a.push(what+param);
            let t = "";
            for(let i = 0; i != a.length-1;++i)
            {
                t = t + a[i] + " ";
            }
            t = t + a[a.length-1];
            return t;
        }

        function get_svg_transform_attr(transform_attr,what){
            let a = [];
            let last_pos = 0;
            for(let i = 0;i < transform_attr.length;++i){
                if (transform_attr.charAt(i) == ")"){
                    a.push(transform_attr.substring(last_pos,i+1));
                    let j = i+1;
                    for(;j != transform_attr.length && transform_attr.charAt(j) == " ";++j);
                    last_pos = j;
                    i = last_pos;
                }
            }
            for(let i = 0; i != a.length;++i){
                if (!a[i].startsWith(what)) continue;
                return a[i];
            }
            return undefined;
        }

        function d3_util_scale(g,scale_x,scale_y){
            let transform_attr = g.attr("transform");
            let new_transform_attr = set_svg_transform_attr(transform_attr,"scale",`(${scale_x} ${scale_y})`);
            g.attr("transform",new_transform_attr);
        }

        function d3_util_translate_rel(g,d_x_rel,d_y_rel){
            let transform_attr = g.attr("transform");
            let translation_attr = get_svg_transform_attr(transform_attr,"translate");
            console.log(translation_attr);
            //g.attr("transform",new_transform_attr);
        }

        function get_all_states_of_sm(sm_name){
            let all_included_states = [];
            let all_toplevel_final_states = [];
            let all_fail_states = [];
            let all_warn_states = [];
            let all_initial_states = [];
            let sm_states = [];
            
            if (states_info.states_per_sm == undefined) {
                states_info.states_per_sm = {};
                states_info.toplevel_final_states_per_sm = {};
                states_info.fail_states_per_sm = {};
                states_info.warn_states_per_sm = {};
                states_info.initial_states_per_sm = {};
                states_info.sm_states_per_sm = {};
            }            
            if (states_info.states_per_sm[sm_name] == undefined){
            
                for(let i = 0; i != states_info.states.length;++i){
                    if (states_info.states[i].full_name == sm_name || states_info.states[i].full_name.startsWith(`${sm_name}.`)){
                        all_included_states.push(states_info.states[i].idx);
                        if ((states_info.states[i].full_name == `${sm_name}.Final`)) all_toplevel_final_states.push(states_info.states[i].idx);
                        if ((states_info.states[i].full_name == `${sm_name}.Initial`)) all_initial_states.push(states_info.states[i].idx);

                        if (states_info.states[i].categories != undefined)
                         for(let j = 0; j != states_info.states[i].categories.length; ++j )
                          if (states_info.states[i].categories[j].category == "FailState") all_fail_states.push(states_info.states[i].idx);
                          else if (states_info.states[i].categories[j].category == "WarnState") all_warn_states.push(states_info.states[i].idx);
                    }
                }
                states_info.states_per_sm[sm_name] = all_included_states;
                states_info.toplevel_final_states_per_sm[sm_name] = all_toplevel_final_states;
                states_info.fail_states_per_sm[sm_name] = all_fail_states;
                states_info.warn_states_per_sm[sm_name] = all_warn_states;
                states_info.initial_states_per_sm[sm_name] = all_initial_states;
                states_info.sm_states_per_sm[sm_name] = sm_states;
            }
            return states_info.states_per_sm[sm_name];
        }

        function is_sm_active(sm_name,active_states){            
            let v = get_all_states_of_sm(sm_name);
            
            for(let i = 0; i != active_states.length; ++i ){
                for(let j = 0; j != v.length; ++j){
                    if (active_states[i] == v[j]) return true;
                }
            }
            return false;     
        }

        function is_in_final_state(sm_name,active_states){
            get_all_states_of_sm(sm_name);
            let v = states_info.toplevel_final_states_per_sm[sm_name];
            //if (sm_name == "trigger_m001"){ console.log("is_in_final_state: ",v,states_info.active_states);}
            for(let i = 0; i != active_states.length; ++i ){
                for(let j = 0; j != v.length; ++j){
                    if (active_states[i] == v[j]) {return true;}
                }
            }
            return false;
        }

        function is_in_fail_state(sm_name,active_states){
            get_all_states_of_sm(sm_name);
            let v = states_info.fail_states_per_sm[sm_name];
            for(let i = 0; i != active_states.length; ++i ){
                for(let j = 0; j != v.length; ++j){
                    if (active_states[i] == v[j]) return true;
                }
            }
            return false;
        }

        function is_in_warn_state(sm_name,active_states){
            get_all_states_of_sm(sm_name);
            let v = states_info.warn_states_per_sm[sm_name];
            for(let i = 0; i != active_states.length; ++i ){
                for(let j = 0; j != v.length; ++j){
                    if (active_states[i] == v[j]) return true;
                }
            }
            return false;
        }

        function is_sm_in_initial_only(sm_name,active_states){
            let all_states = get_all_states_of_sm(sm_name);
            let v = states_info.initial_states_per_sm[sm_name];
            //console.log(all_states);console.log(v);
            
            for(let i = 0; i != active_states.length; ++i ){
                for(let j = 0; j != all_states.length; ++j){
                    if (active_states[i] != all_states[j]) continue;
                    let b = false;
                    for(let k = 0; k!=v.length;++k ){
                        if (v[k] == all_states[j]) {b = true;break;}
                    }
                    if (!b){
                        for(let k = 0; k!=states_info.sm_states_per_sm[sm_name].length;++k ){
                            if (states_info.sm_states_per_sm[sm_name][k] == all_states[j]) {b = true;break;}
                        }                        
                    }
                    if(!b) return false;                    
                }
            }
            return true;
        }

        function get_sm_lane(sm_name,active_states){
            if (!is_sm_active(sm_name,active_states)) return '#toplevel_sms_inactive';
            if (is_sm_in_initial_only(sm_name,active_states)) return '#toplevel_sms_inactive';
            if (is_in_fail_state(sm_name,active_states)) return "#toplevel_sms_in_error_state";
            if (is_in_warn_state(sm_name,active_states)) return "#toplevel_sms_in_warn_state";
            if (is_in_final_state(sm_name,active_states)) return "#toplevel_sms_in_final_state";
            return '#toplevel_sms';
        }

        function setup_tile(tile_scale,sm_name,svg_orig_width,svg_orig_height){                               

            d3_util_scale(d3.select(`#sm_viz_${sm_name}`).select("svg").select("g"),tile_scale,tile_scale);

            $(`#sm_viz_container_parent_div_${sm_name}`).mouseenter(
                                    function(ev){
                                        if (!$(`#sm_viz_${sm_name}`).hasClass("ceps-ui-tile")) return;
                                        if (tile_scale < 1.0) {
                                            new_tile_scale = tile_scale * 5.0;
                                            if (new_tile_scale > 1.0) new_tile_scale = 1.0;
                                            d3_util_scale(d3.select(`#sm_viz_${sm_name}`).select("svg").select("g"),new_tile_scale,new_tile_scale);
                                        }                                        
                                    }
            );

            $(`#sm_viz_container_parent_div_${sm_name}`).mouseleave(
                function(ev){
                    if (!$(`#sm_viz_${sm_name}`).hasClass("ceps-ui-tile")) return;
                    let sm_viz_container = $(`#sm_viz_container_${sm_name}`);
                    d3_util_scale(d3.select(`#sm_viz_${sm_name}`).select("svg").select("g"),tile_scale,tile_scale);
                    sm_viz_container.css("top",0);
                    sm_viz_container.css("left",0);
                }
            );                                
                                
            $(`#sm_viz_container_parent_div_${sm_name}`).mousemove(
                function(ev){
                    if (!$(`#sm_viz_${sm_name}`).hasClass("ceps-ui-tile")) return;
                    let sm_viz_container = $(`#sm_viz_container_${sm_name}`);
                    let w_pic = svg_orig_width * new_tile_scale;
                    let h_pic = svg_orig_height * new_tile_scale;

                    let w_parent = $(`#sm_viz_container_parent_div_${sm_name}`).width();
                    let h_parent = $(`#sm_viz_container_parent_div_${sm_name}`).height();

                    let m_pos_y = ev.pageY - $(`#sm_viz_container_parent_div_${sm_name}`).offset().top;
                    let m_pos_x = ev.pageX - $(`#sm_viz_container_parent_div_${sm_name}`).offset().left;

                    if (m_pos_y + 4 > h_parent) m_pos_y = h_parent;
                    if (m_pos_x + 4 > w_parent) m_pos_x = w_parent;
                                        
                    if (m_pos_y > h_parent) m_pos_y = h_parent;
                    if (m_pos_x > w_parent) m_pos_x = w_parent;
                                      
                    let sy = m_pos_y / h_parent; if (sy > 1.0) sy = 1.0;
                    let sx = m_pos_x / w_parent; if (sx > 1.0) sx = 1.0;
                                        
                    let pos_in_pic_y = sy * h_pic ;// * h_pic;
                    let pos_in_pic_x = sx * w_pic;
                                        
                    let dy = -(pos_in_pic_y - m_pos_y);
                    if (dy + h_pic < h_parent) dy = h_parent - h_pic;
                    if (dy >= 0) dy = 0;
                    sm_viz_container.css("top",  dy);
                                        
                    let dx = -(pos_in_pic_x - m_pos_x);
                    if (dx + w_pic < w_parent) dx = w_parent - w_pic;
                    if (dx >= 0) dx = 0;
                    sm_viz_container.css("left",  dx);                                  
                    }
                );
        }


        function fetch_sm_svgs_from_simcore(ws) {
            function h(ev) {
                ws.removeEventListener("message", h);

                //console.log(ev.data);


                let msg = JSON.parse(ev.data);
                /*console.log("query root");
                console.log(msg);
                console.log("fetch_sm_svgs_from_simcore");*/
                console.log(msg.sresult);
                for(let k = 0; k != msg.sresult.length;++k) {
                    if (msg.sresult[k].name != "sm" || msg.sresult[k].type != "struct") continue;
                    consumed_events[id_of_sm(msg.sresult[k])] = compute_consumed_events(msg.sresult[k]);
                }
                if (msg.ok) {
                    for(let i = 0; i != msg.sresult.length;++i){
                        let e = msg.sresult[i];
                        if(e.name != "__dot_gen" || e.type != "struct") continue;
                        let v = {};
                        simplifyceps2json(v,e);
                        
                        console.log(v);
                        let svgs_to_load = v.sm.length;
                        states_info.states = v.states[0].state;
                        console.log("states_info.states",states_info.states);
                        for(let i = 0; i != v.sm.length;++i){
                            $.get(v.sm[i].svg_filename,{},function(res){

                                let lane = undefined;

                                $(lane = get_sm_lane(v.sm[i].name,states_info.active_states)).append(html_gen_sm_widget(v.sm[i].name,/*res*/"",false,true));

                                if (states_info.lane == undefined) states_info.lane={};
                                states_info.lane[v.sm[i].name] = lane;

                                /*let svg_orig_height = parseFloat(d3.select(`#sm_viz_${v.sm[i].name}`).select("svg").style("height"));
                                let svg_orig_width = parseFloat(d3.select(`#sm_viz_${v.sm[i].name}`).select("svg").style("width"));

                                let svg_scale_y = layout_info.sm_widget_tile.height / svg_orig_height;
                                let svg_scale_x = layout_info.sm_widget_tile.width / svg_orig_width;

                                if (svg_scale_y > svg_scale_x) svg_scale_y = svg_scale_x;
                                if (svg_scale_x > svg_scale_y) svg_scale_x = svg_scale_y;
                                if (svg_scale_x >= 1.0) {svg_scale_x = 1.0;svg_scale_y = 1.0;}
                                if (svg_scale_y >= 1.0) {svg_scale_x = 1.0;svg_scale_y = 1.0;}
                                let tile_scale = svg_scale_x; if (tile_scale < 0.1)tile_scale = 0.1;
                                let new_tile_scale = tile_scale;*/

                                components[v.sm[i].name] = {};
                                components[v.sm[i].name].setup_tile = function(){setup_tile(tile_scale,v.sm[i].name,svg_orig_width,svg_orig_height);}

                                svgs.push({name:v.sm[i].name, data:res/*, tile_scale:tile_scale,svg_orig_width:svg_orig_width,svg_orig_height:svg_orig_height*/});
                                svgs_to_load--;
                                if (svgs_to_load == 0){
                                    
                                    $('#input_search_statemachines').bind("input",function(){
                                        on_change_input_search_statemachines();
                                    });
                                }
                            },"text");                          
                        }
                        break;
                    }
                }
                //fetch_frames_from_simcore(ws);
            }           

            let active_states_monitoring_ws = new WebSocket("ws://"+remote_url);

            function active_states_monitoring_ws_open(){
                start_ceps_proc_consumer(active_states_monitoring_ws);
                let t = callback_proc_consumer;
                callback_proc_consumer = function () {
                    callback_proc_consumer = update_gui;
                    ws.addEventListener("message", h);
                    ws.send("QUERY root;");
                };
            }
            function active_states_monitoring_ws_close(){
                
            }
            function active_states_monitoring_ws_error(){
                
            }

            active_states_monitoring_ws.addEventListener("open", active_states_monitoring_ws_open);
            active_states_monitoring_ws.addEventListener("close", active_states_monitoring_ws_close);
            active_states_monitoring_ws.addEventListener("error", active_states_monitoring_ws_error);       
            
            /*start_ceps_proc_consumer(ws);
            
            ws.addEventListener("message", h);
            ws.send("QUERY root;");*/
        }


        function fetch_exported_events_from_simcore(ws) {
            function h(ev) {
                ws.removeEventListener("message", h);
                let msg = JSON.parse(ev.data);
                if (msg.ok && msg.number_exported_events > 0) {
                    msg.sresult.forEach((e) => { simcore_events.push(new Eventinfo(e)); });                                        
                }
                fetch_sm_svgs_from_simcore(ws);
            }
            ws.addEventListener("message", h);
            ws.send("EXPORTED_EVENTS");
        }

        function fetch_data_from_simcore(ws) {
            function h(ev) {
                ws.removeEventListener("message", h);
                let msg = JSON.parse(ev.data);
                if (msg.ok) {
                    global_sysstates = msg.global_states;
                }
                fetch_exported_events_from_simcore(ws);
            }
            ws.addEventListener("message", h);
            ws.send("GLOBAL_SYSSTATES");
        }

        function fetch_data_from_remote(ws) {
            ws.send("KNOWN_SIMCORES");
            function h(ev) {
                ws.removeEventListener("message", h);                
                let msg = JSON.parse(ev.data);                
                if (msg.ok) {
                    let dt = [];
                    for (let e of msg.simcores) {
                        let hn = (e.host_name.length == 0 ? "localhost" : e.host_name);
                        let url = hn + ":" + e.ws_api_port;
                        dt.push([`<a href="#" onclick="$('#dlg_select_a_simulation').modal('hide');connect_to_simcore('${url}')" >`+e.name+"</a>",
                            e.short_name, url]);
                    }
                    if (dt.length == 0) {
                        fetch_data_from_simcore(ws);
                        return;
                    }
                    $("#dlg_select_a_simulation").modal("show");
                    if (dlg_select_a_simulation_table_data == undefined)
                        dlg_select_a_simulation_table_data = $('#dlg_select_a_simulation_table').DataTable({
                            select: {
                                style: 'single'
                            },
                            data: dt,
                            columns: [{ title: "Name" }, { title: "Short Name" }, {title:"Host"}]
                        });
                    else {
                        $('#dlg_select_a_simulation_table').DataTable().clear().rows.add(dt).draw();
                    }
                    return;
                }
                fetch_data_from_simcore(ws);
            }
            ws.addEventListener("message", h);
        }

        var login_retry_timeout = undefined;
        function stop_login_retry_timeout() {
            if (login_retry_timeout == undefined) return;
            window.clearTimeout(login_retry_timeout);
            login_retry_timeout = undefined;
        }

        function enter_credentials() {
           $('#dlg_login').modal('show');
        }

        var failed_connect_notification_container = undefined;
        function show_failed_connect_notification(url) {
            if (failed_connect_notification_container != undefined) {
                failed_connect_notification_container.close();
            }
            var time_elapsed_to_retry_connect = 10;
            function time_elapsed_to_retry_connect_fn(){
                --time_elapsed_to_retry_connect;
                if (time_elapsed_to_retry_connect <= 0) {
                    if (failed_connect_notification_container != undefined) {
                        failed_connect_notification_container.close();
                        setTimeout(() => { do_login(remote_url); }, 1500);
                    }
                } else {
                    $("#info_btn_log_again").html(time_elapsed_to_retry_connect.toString());
                    login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
                }
            }
            login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
            failed_connect_notification_container=
            $.notify({/* options*/message: 'Failed to connect with \'' + url +
                `' <p></p><button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick="stop_login_retry_timeout();do_login('${remote_url}');">Try again in <span id="info_btn_log_again">${time_elapsed_to_retry_connect}</span> seconds</button>&nbsp;&nbsp;` +
                `<button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick=" stop_login_retry_timeout();enter_credentials();">Reenter Credentials</button>`
            },
                {/*settings*/ delay: 0, type: 'danger', showProgressbar: false,
                    animate: { enter: 'animated zoomInDown', exit: 'animated zoomOutUp' }
                }
            );                    
        }

        function connection_lost() {
            connected = false;
            simcore_ws = undefined;
            let l = $(".depend-on-signal-data");
            for (let e of l) {
                $(e).addClass("waiting-for-data");
            }
            for (let s of signals) {
                s.value = undefined;
            }
            setTimeout(() => { for (let e of l) update_widget_ctrl($(e)); }, 10);
            show_failed_connect_notification(remote_url);
        }


        let main_socket = undefined;
        function on_ws_initial_connect(ev) {
                 
            fetch_data_from_remote(main_socket);
        }

        function on_ws_close(ev) {
            if (main_socket != simcore_ws) return;
            connection_lost();                    
        }

        function on_ws_error(ev) {
            connected = false; simcore_ws = undefined;
            connection_lost();
        }

        function do_login(url) {
            new_remote_site = remote_url != url;
            remote_url = url;          
            connected = false;
            main_socket = new WebSocket("ws://"+url);
            main_socket.addEventListener("open", on_ws_initial_connect);
            main_socket.addEventListener("close", on_ws_close);
            main_socket.addEventListener("error", on_ws_error);                
        }

        function login(url) {
            $('#dlg_login').modal('hide');
            do_login(url);
        }


        
        $(document).ready(() => {
            setInterval(() => {
                for (let e of global_observer_handlers) if (e.handler != undefined) e.handler();
             } , 10);

            if (!connected)
                setTimeout(() => {
                    $('#dlg_login').modal('show');
                }, 0);
        });
    </script>
</body>

</html>
