<!DOCTYPE html>
<html lang=en>
<!-- 
    
    Cool effects

    https://blog.trackduck.com/2015/06/10/15-impressive-pop-animation-effects-codepen/
    
    
    -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="(c) ceps technologies, all rights reserved">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="jquery-ui/jquery-ui.min.css" rel="stylesheet">
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- link href="datatables/css/dataTables.material.min.css" rel="stylesheet" -->
    <!-- link href="datatables/css/jquery.dataTables.min.css" rel="stylesheet" -->
    <link href="datatables/css/dataTables.bootstrap.min.css" rel="stylesheet" >
    <link href="datatables-responsive/dataTables.responsive.css" rel="stylesheet">
    <link href="cepscloud-ui/cepscloud-ui.css" rel="stylesheet">
    <link href="animate/animate.css" rel="stylesheet">
    <style>
    </style>
    <title>Prototype Control Panel</title>
</head>

<script>
    var global_observer_handlers = [];

    function register_observer(name, fn) {
        for (let e of global_observer_handlers)
            if (e.name == name) { e.handler = fn; return; }
        if (fn == undefined) return;
        for (let e of global_observer_handlers)
            if (e.handler == undefined) { e.name = name; e.handler = fn; return; }

        global_observer_handlers.push({name:name, handler:fn});
    }

    function unregister_observer(name) { register_observer(name, undefined); }

</script>
<body>

    <div class="row">
        <div class="col-xs-6 col-sm-2"></div>
        <div class="col-xs-6 col-sm-8">
            <h2>Control Panel </h2>
        </div>
        <div class="col-xs-6 col-sm-2"></div>
    </div>
    <div class="row">
        <div class="col-xs-6 col-sm-2">
            
        </div>
        <div class="col-xs-6 col-sm-8">
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color:white;">
                        <div class="btn-toolbar" role="toolbar">
                            <div class="btn-group btn-group-xs" role="group">
                                <button id="ctrl_panel_editor_btn_add" type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
                                <!--button id="ctrl_panel_editor_btn_add_paragraph" type="button" class="btn btn-default btn-xs"><i class="fa fa-paragraph" aria-hidden="true"></i></button-->
                            </div>
                        </div>
                    </div>
                    <div id="ctrl_panel_editor" class="panel-body" >

                    </div>
                </div>
            </div>
            <div class="col-xs-6 col-sm-2"></div>
        </div>



    <!---------------------------- COMPONENT: Login ---------------------------->
    <div class="modal fade" id="dlg_login" tabindex="-1" role="dialog" aria-labelledby="dlg_login">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Login</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <div class="input-group">
                        <span class="input-group-addon"><i class="glyphicon glyphicon-log-in"></i></span>
                        <!--input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:10163" placeholder=""-->
                        <input id="sim_url" type="text" class="form-control" name="user" value="tomas-cepsdev-win:1063" placeholder="">

                    </div>                      
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary" onclick="login($('#sim_url').val());">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Login ---------------------------->





 

    <!---------------------------- COMPONENT: Choose Signal ---------------------------->
    <div class="modal fade" id="dlg_select_a_signal" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_signal_label">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_signal_label">Choose a Signal</h4>
                </div>
                <div id="dlg_select_a_signal_body" class="modal-body">
                    <table id="dlg_select_a_signal_table" class="table table-striped table-bordered" width="100%"></table>

                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_signal_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="dlg_select_a_signal_btn_ok" type="button" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Signal ---------------------------->


    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
    <div class="modal fade" id="dlg_select_a_ctrlpanel" tabindex="-1" role="dialog" aria-labelledby="dlg_select_a_ctrlpanel_label">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="dlg_select_a_ctrlpanel_label">Choose a Control Panel</h4>
                </div>
                <div id="dlg_select_a_ctrlpanel_body" class="modal-body">
                    <table id="dlg_select_a_ctrlpanel_table" class="table table-striped table-bordered" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button id="dlg_select_a_ctrlpanel_btn_close" type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button id="dlg_select_a_ctrlpanel_btn_ok" type="button" class="btn btn-primary">Ok</button>
                </div>
            </div>
        </div>
    </div>
    <!---------------------------- COMPONENT: Choose Control Panel ---------------------------->
       




    <script src="jquery/js/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="jquery-ui/jquery-ui.min.js"></script>
    <script src="datatables/js/jquery.dataTables.min.js"></script>
    <script src="datatables-plugins/dataTables.bootstrap.min.js"></script>
    <script src="datatables-responsive/dataTables.responsive.js"></script>
    <script src="chartjs/Chart.js"></script>
    <script src="bootstrap-notify/bootstrap-notify.js"></script>
    <script src="cepscloud-ui/widget_properties_panel.js"></script>
    <script src="cepscloud-ui/widget_toggle_signal.js"></script>
    <script src="cepscloud-ui/widget_plot_signal.js"></script>
    <script src="cepscloud-ui/persistence.js"></script>

    <script>
        let ctrlPanelEditor = undefined;
    </script>

    <!---------------------- Persistence ----------------------->

    <script>
        let ctrlpanel_infos = [];
        let dlg_select_a_ctrlpanel_table = undefined;

        function set_ctrlpanel_infos(l) {
            if (l.length == 0) {
                    ctrlpanel_infos = []; return;
            }
            ctrlpanel_infos = new Array(l.length);
            for (let i = 0; i != l.length; ++i) {
                    ctrlpanel_infos[i] = l[i];
                ctrlpanel_infos[i].id = i;
            }
        }

        function get_ctrlpanel_infos() {
            return ctrlpanel_infos;
        }

        function ctrlpanel_info_get_name(ctrlpanel) {
            for (let e of ctrlpanel.content) {
                if (e.type != "struct" || e.name != "name" || e.content.length != 1) continue;
                return e.content[0];
            }
            return undefined;
        }

        function ctrlpanel_info_get_widget_property(e,n) {
            for (let ee of e.content) {
                if (ee.type == "struct" && ee.name == n) return ee.content;
            }
            return undefined;
        }

        function widget_descr_extract_type(widget_descr_type_prop) {
            if (widget_descr_type_prop.length == 0) return undefined;
            return widget_descr_type_prop[0];
        }

        function widget_descr_extract_assoc_sysstate(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            if (e[0].type == "symbol" && e[0].kind == "Systemstate") return e[0].name;
            return undefined;
        }

        function widget_descr_extract_style(e) {
            if (e.length == undefined || e.length == 0) return undefined;
            let r = {};
            for (let ee of e) {
                if (ee.type != "struct") continue;
                if (ee.name == "height") r.height = ee.content[0];
                else if (ee.name == "width") r.width = ee.content[0];
            }
            return r;
        }

        function ctrlpanel_info_get_widget_descr(e) {
            
            if (e.type != undefined && e.type == "struct" && e.name == "widget") {
                try {
                    let t = undefined;                   
                    return [true, {
                        type: (t = ctrlpanel_info_get_widget_property(e, "type")) != undefined ? widget_descr_extract_type(t) : undefined,
                        associated_systemstate: (t = ctrlpanel_info_get_widget_property(e, "associated_systemstate")) != undefined ? widget_descr_extract_assoc_sysstate(t) : undefined,
                        style: (t = ctrlpanel_info_get_widget_property(e, "style")) != undefined ? widget_descr_extract_style(t) : undefined
                    }];
                } catch (error) {
                    
                }
            }
            return [false];
        }




        function ctrlpanel_dlg_decorate_ctrlpanel_table_entry(e,pnl_info) {
            return "<a href='#' onclick='load_ctrlpanel_given_id(" + pnl_info.id+");'>" + e + "</a>";
        }

        function choose_ctrlpanel_dlg() {
                    let data = [];
            columns = [{title: "Name" }];
            //["<a href='#' onclick='handle_signal_select(\"" + sig.name + "\");'>" + sig.name + "</a>", sig.comment]
            get_ctrlpanel_infos().forEach((elem) => {
                    let t = ctrlpanel_info_get_name(elem);
                if (t == undefined) data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry("<i>No Title</i>", elem)]);
                else data.push([ctrlpanel_dlg_decorate_ctrlpanel_table_entry(t, elem)]);
            })

            dlg_select_a_ctrlpanel_table = $('#dlg_select_a_ctrlpanel_table').DataTable({
                    select: {
                    style: 'single'
                },
                data: data,
                columns: columns
            });
            $("#dlg_select_a_ctrlpanel").modal("show");
        }

        function load_ctrlpanel_given_id(id) {
                    $("#dlg_select_a_ctrlpanel").modal("hide");
                let cpnl_info = undefined;
            for (let e of ctrlpanel_infos) {
                if (e.id == id) {
                    cpnl_info = e;
                    break;
                }
            }
            if (cpnl_info == undefined) return;
            build_ctrlpanel_from_json(ctrlPanelEditor, cpnl_info);
        }
    </script>


    <!---------------------- Persistence ----------------------->

    <!---------------------- Signals ----------------------->
    <script>
        function Signalinfo(n, v, tv, c, s, r, f, i) {
            this.name = n;
            this.value = v;
            this.target_value = tv;
            this.comment = c;
            this.sender = s;
            this.receiver = r;
            this.frames = f;
            this.info = i;
            this.observed_min = undefined;
            this.observed_max = undefined;
        }
        var signals = [];
        var signals_dt = undefined;
    </script>
    <!---------------------- Signals ----------------------->
    
    
    

    <script>
        var dlg_select_a_signal_table_dataset = [];        

        var dlg_select_a_signal_table_columns = [
            { title: "Name" },
            { title: "Comment" },
        ];

        const slider_granularity_default = 4096;

        function generate_test_data() {
            signals = [
                new Signalinfo("Signal A", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], {type:"float",min:-2,max:2}),
                new Signalinfo("Signal B", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10 }),
                new Signalinfo("Signal C", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal D", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal E", 2,2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val:1, name: "b" }, { val:2, name:"c" }] }),
                new Signalinfo("Signal F", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal G", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal H", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal I", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal J", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal K", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal L", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal M", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal N", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal O", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal P", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal Q", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal R", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal S", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal T", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal U", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" }),
                new Signalinfo("Signal V", 0.5,0.5, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 2 }),
                new Signalinfo("Signal W", 2, 2, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "int", min: 0, max: 10, vm: [{ val: 0, name: "a" }, { val: 1, name: "b" }, { val: 2, name: "c" }] }),
                new Signalinfo("Signal X", 11.1,11.1, "aksdhkja asjkhdjkshdaakj",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: 0, max: 20, unit: "kg" })
            ];
        }

        function set_signal_target_value(widget_id, tv, signal_name) {            
            let sig = get_signal_by_name(signal_name);
            sig.target_value = tv;
            for (let e of widget_infos) {
                if (e.id == widget_id) continue;             
                if (e.info.type.sig && e.info.toggle_sig && (e.info.sig_name == signal_name) ) {
                    e.ext.set_value(tv);
                }
            }
        }

        function map_sig_target_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2,31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31))+1;
        
            d = (mx - mn);
            let rr = ((signal.target_value - mn) / d) * r;
            return rr;
        }

        function map_sig_value_to_range(signal, r) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((signal.value - mn) / (d)) * r;
            return rr;
        }

        function map_range_index_to_value(signal, r, i) {
            let mx = signal.info.max;
            let mn = signal.info.min;
            let d = 0;
            if (mx == undefined) mx = Math.round(Math.pow(2, 31));
            if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;
            d = (mx - mn);

            let rr = ((i / r) * d) + mn;
            if (signal.info.type == "float")
                return Math.round(rr * 10000) / 10000.0;
            if (signal.info.type == "int") {
                rr = Math.min(Math.round(rr), signal.info.max);
                if (rr < signal.info.min) rr = signal.info.min;
                return rr;
            }
            else return rr;
        }

        //generate_test_data();

        function get_signal_by_name(n) {
            for (let e of signals) if (e.name == n) return e;
            return undefined;
        }
        
        
        function dlg_select_a_signal_populate_dataset(){
            ds = [];
           
            for (let sig of signals) {               
                ds.push(["<a href='#' onclick='handle_signal_select(\"" + sig.name+"\");'>"+sig.name+"</a>",sig.comment]);
            }

            return ds;            
        }

        function Widget(id) { this.type_ = "undefined"; }
        Widget.prototype.type = function () { return this.type_; }
        Widget.prototype.set_type = function (t) { this.type_ = t; }

        function dlg_set_widget_type_get_results() {
            return {
                toggle_signal: $("#dlg_set_widget_type_r1").is(":checked"),
                show_signal: $("#dlg_set_widget_type_r2").is(":checked"),
                plot_signal: $("#dlg_set_widget_type_r3").is(":checked"),
                trigger_event: $("#dlg_set_widget_type_r4").is(":checked"),
                run_script: $("#dlg_set_widget_type_r5").is(":checked")
            };
        }

        function helper_make_toggle_widget_sel_list(signal,v) {
            let l = ["- No Mapping Available -"];
            let sel_index = 0;
            let i = 1;
            for (e of signal.info.vm) {
                l.push(e.name);
                if (Math.abs(v) < Number.MIN_VALUE)
                { if (Math.abs(v - e.val) <= Number.MIN_VALUE) sel_index = i; }
                else
                { if (Math.abs(v - e.val) / Math.abs(v) <= Number.MIN_VALUE) sel_index = i; }
                ++i;
            }
            return [l,sel_index];
        }

        function helper_display_unit_and_format(unit, format){
            let r = "";
            if (unit == undefined || unit.length == 0) r += "scalar"; else r += unit;
            if (format == "Hexadecimal") r += " <small>( hex. )</small>";
            else if (format == "Octal") r += " <small>( oct. )</small>";
            else if (format == "Binary") r += " <small>( bin. )</small>";
            else r += " <small>( dec. )</small>";
            return r;
        }

        function helper_make_widget_content_with_loader() {
            
            return `<table width="100%" valign="center">
                     <tr>
                      <td width="70px"><div class="loader" style="float: left;"></div></td>
                      <td width="15px"></td><td align="left"><h4><span class="label label-default">Fetching Data</span></h4></td>
                     </tr>
                    </table>`;
        }

        function helper_make_toggle_widget_content(widget_id, signal, watch) {
            if (watch == undefined) watch = false;
            let widget_content = "";
            if (signal.value == undefined) {
                widget_content = helper_make_widget_content_with_loader();                    
            }
            else {
                if (signal.info.vm != undefined && signal.info.vm.length > 0) {
                    let [l, sel_index] = helper_make_toggle_widget_sel_list(signal, signal.target_value);
                    widget_content =
                        `
                 <table width='100%'>
                  <tr>
                   <td width='50%'>
                     <div id='dummy_${widget_id}'></div>
                   </td>
                   <td width='50%'>
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                       <select id="${widget_id}_select_ctrl" class="form-control">
                          ${helper_build_sel_html(l, sel_index)}
                        </select>
                        <input type ="text" style="width:100%;" id="${widget_id}_text_ctrl" 
                               class="form-control" value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                               ${watch ? "disabled" : "enabled"}>
                        <span class="input-group-addon" >${helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>                        
                    </div>
                  </td>
                 </tr>
                </table>`;

                } else {
                    widget_content =
                        `
                <table width="100%">
                 <tr>
                  <td style="min-width:30px;width:50%;">
                   <div id='dummy_${widget_id}'></div>
                  </td>
                  <td style="min-width:160px;width:50%;"> 
                   <div id="${widget_id}_input_group" class="input-group input-group-sm baseWidget-edit">
                    <input type ="text" style="width:100%;"
                           id="${widget_id}_text_ctrl" 
                           class="form-control"
                           value="${sig_value_text_representation(signal, (watch?signal.value:signal.target_value), get_widget_info(widget_id).display)}" 
                           ${watch ? "disabled" : "enabled"}>
                    <span class="input-group-addon" >${ helper_display_unit_and_format(signal.info.unit, get_widget_info(widget_id).display)}</span>
                   </div>
                  </td>
                 </tr>
                </table>`;
                }
            }
            
            return widget_content;
        }

        function validate_input(signal, text, format) {
            let v = NaN;
            if (signal.info.type == "float") {
                v = parseFloat(text);
            } else if (signal.info.type == "int") {
                
                if (format == "Hexadecimal") {
                    if (text.match(/^(\-)?([0-9]|a|b|c|d|e|f)+$/)) v = parseInt(text, 16);
                } else if (format == "Octal") {
                    if (text.match(/^(\-)?([0-7])+$/))v = parseInt(text, 8);
                } else if (format == "Binary") {
                    if (text.match(/^(\-)?([0-1])+$/))v = parseInt(text, 2);
                } else {
                    if (text.match(/^(\-)?([0-9])+$/)) v = parseInt(text);
                }
            }
            if (!isNaN(v)) {
                let mx = signal.info.max;
                let mn = signal.info.min;
                if (mx == undefined) mx = Math.round(Math.pow(2, 31));
                if (mn == undefined) mn = -Math.round(Math.pow(2, 31)) + 1;

                if (v < mn) return [false, v, "Too Small."];
                if (v > mx) return [false, v, "Too Big."];
            }

            return [!isNaN(v),v, text.length==0 ? "No Input" : "That's not a number"];
        }
        function sig_value_text_representation(signal, v, format) {
            if (signal.info.type == "int") {
                if (format == "Hexadecimal") return v.toString(16);
                else if (format == "Octal") return v.toString(8);
                else if (format == "Binary") return v.toString(2);                 
            }
            return v.toString();
        }
        
        function handle_widget_click_header(widget_id, ev) {
            
            event.preventDefault();
            $(".baseWidget-selected").removeClass("baseWidget-selected");
            let widget = $("#" + widget_id); 
            widget.addClass("baseWidget-selected");

            $("#widget_properties_panel").removeClass("prop-panel-transition-1");
            $("#widget_properties_panel").removeClass("prop-panel-transition-2");
            $("#widget_properties_panel").addClass("prop-panel-transition-2");

            update_prop_panel(widget);
            return false;
        }

        function CtrlPanelComponentTemplates() {
            this.id_counter = 0;
        }

        function close_widget(ev,widget_id) {
            ev.stopPropagation();
            $("#" + widget_id).addClass("baseWidget-remove");
            
            setTimeout(() => {
                $("#" + widget_id).remove();
            }, 500);
            return false;
        }

        CtrlPanelComponentTemplates.prototype.baseWidget = function () {
            this.id_counter++;
            return [`widget_${this.id_counter}`,`<div id="widget_${this.id_counter}" class="baseWidget baseWidget-not-initialized">
                    <div id="header_of_widget_${this.id_counter}" class="header" onclick="handle_widget_click_header('widget_${this.id_counter}',event)"> 
                      <i>Click to configure...</i>
                      <button type="button" class="btn btn-xs close" aria-label="Close" onclick="close_widget(event,'widget_${this.id_counter}');" style="transform: translateY(-11px);">
                        <span aria-hidden="true" class="small" >&times;</span>
                      </button>
                    </div>
                    <div id="content_of_widget_${this.id_counter}" class="baseWidget-content"></div>   
                    </div>`];
        }
        CtrlPanelComponentTemplates.prototype.paragraph = function () {
            return `<br>`;
        }

        function CtrlPanelEditor(ctrl_editor_component, widget_templates) {
            this.ctrl_editor_component_ = ctrl_editor_component;
            this.widget_templates_ = widget_templates;
        }
        CtrlPanelEditor.prototype.view = function () { return this.ctrl_editor_component_; }
        CtrlPanelEditor.prototype.widgetTemplates = function () { return this.widget_templates_; }
        CtrlPanelEditor.prototype.addWidget = function () {
            let r = this.widgetTemplates().baseWidget();
            this.ctrl_editor_component_.append(r[1]);
            return r[0];
        }
        CtrlPanelEditor.prototype.addParagraph = function () {
            this.ctrl_editor_component_.append(this.widgetTemplates().paragraph());
        }

       
    </script>



    <script>
        function traverse_ceps_as_json(doc, f) {
            if (doc === undefined) return true;
            if (Object.prototype.toString.call(doc) == "[object Array]") {
                for (let e of doc) {
                    if (!f(e)) return false;
                    if(!traverse_ceps_as_json(e, f)) return false;
                }
                return true;
            } else if (doc.content) {
                return(traverse_ceps_as_json(doc.content, f));
            }
            return f(doc);
        }

    </script>

    <script>
        var connected = false;
        var new_remote_site  = false;
        var remote_url = undefined;
        var simcore_ws = undefined;

        function simcore_ws_process_messages(ev) {
            let msg = JSON.parse(ev.data);
            if (!msg.ok) return;
            if (msg.signals) {
               for (let s of msg.signals) {
                   let sig = get_signal_by_name(s.name);
                   if (!sig) continue;
                   sig.value = s.value;
                   if (sig.target_value == undefined) sig.target_value = sig.value;
                   if (sig.observed_min == undefined || sig.observed_max == undefined) {
                       sig.observed_min = sig.value;
                       sig.observed_max = sig.value;
                   } else {
                       sig.observed_min = Math.min(sig.value, sig.observed_min);
                       sig.observed_max = Math.max(sig.value, sig.observed_max);
                   }


                   for (let wi of widget_infos) {
                       if (wi.info.type.sig && !wi.info.toggle_sig && (wi.info.sig_name == s.name)) {
                           if (wi.ext && wi.ext.set_value) wi.ext.set_value(sig.value);
                       }
                   }

               }
            }
        }

        function finish_prologue(ws) {
            ws.addEventListener("message", simcore_ws_process_messages);
            simcore_ws = ws;
            connected = true;
            if (new_remote_site) {
                setTimeout(() => { choose_ctrlpanel_dlg(); }, 1000);
            }
        }

        function fetch_data_from_remote(ws) {
            ws.send("QUERY root.frame;");
            function process_ctrlpanels_resultset(ev) {
                let msg = JSON.parse(ev.data);
                if (msg.ok) {
                    for (let cpldescr of msg.sresult)
                        console.log(cpldescr);
                    set_ctrlpanel_infos(msg.sresult);
                }
                ws.removeEventListener("message", process_ctrlpanels_resultset);
                finish_prologue(ws);
            }
            function process_frames_resultset(ev) {
                let msg = JSON.parse(ev.data);
                //console.log(ev.data);
                if (msg.ok) {
                    ws.removeEventListener("message", process_frames_resultset);
                    let set_of_signals = new Set();
                    traverse_ceps_as_json(msg.sresult, (entry) => {
                        if (entry.type != undefined) if (entry.type == "symbol" && entry.kind == "Systemstate") {
                            set_of_signals.add(entry.name);
                        }
                        return true;
                    });
                    let list_of_signals = Array.from(set_of_signals).sort();
                    for (let s_name of list_of_signals) {
                        signals.push(new Signalinfo(s_name, undefined, undefined, "",/*sender*/[],/*receiver*/[],/*frames*/[], { type: "float", min: undefined, max: undefined }));
                    }
                    ws.addEventListener("message", process_ctrlpanels_resultset);
                    ws.send("QUERY root.ctrlpanels.content();");
                }
            };

            ws.addEventListener("message", process_frames_resultset );
        }
        var login_retry_timeout = undefined;
        function stop_login_retry_timeout() {
            if (login_retry_timeout == undefined) return;
            window.clearTimeout(login_retry_timeout);
            login_retry_timeout = undefined;
        }

        function enter_credentials() {
           $('#dlg_login').modal('show');
        }

        var failed_connect_notification_container = undefined;
        function show_failed_connect_notification(url) {
            if (failed_connect_notification_container != undefined) {
                failed_connect_notification_container.close();
            }
            var time_elapsed_to_retry_connect = 10;
            function time_elapsed_to_retry_connect_fn(){
                --time_elapsed_to_retry_connect;
                if (time_elapsed_to_retry_connect <= 0) {
                    if (failed_connect_notification_container != undefined) {
                        failed_connect_notification_container.close();
                        setTimeout(() => { do_login(remote_url); }, 1500);
                    }
                } else {
                    $("#info_btn_log_again").html(time_elapsed_to_retry_connect.toString());
                    login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
                }
            }
            login_retry_timeout = setTimeout(time_elapsed_to_retry_connect_fn, 1000);
            failed_connect_notification_container=
            $.notify({/* options*/message: 'Failed to connect with \'' + url +
                `' <p></p><button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick="stop_login_retry_timeout();do_login('${remote_url}');">Try again in <span id="info_btn_log_again">${time_elapsed_to_retry_connect}</span> seconds</button>&nbsp;&nbsp;` +
                `<button type="button" class="btn btn-primary btn-xs" data-dismiss="alert" onclick=" stop_login_retry_timeout();enter_credentials();">Reenter Credentials</button>`
            },
                {/*settings*/ delay: 0, type: 'danger', showProgressbar: false,
                    animate: { enter: 'animated zoomInDown', exit: 'animated zoomOutUp' }
                }
            );                    
        }


        function do_login(url) {
            new_remote_site = remote_url != url;
            remote_url = url;          
            connected = false;
            (() =>
            {
                let socket = new WebSocket("ws://"+url);
                socket.addEventListener("open", (ev) => {
                    $.notify({/* options*/message: 'Connected with \'' + url +  `'`},
                        {/*settings*/ type: 'success', showProgressbar: false,delay : 2000,
                            animate: { enter: 'animated rollIn', exit: 'animated rollOut' }
                        }
                    );
                    fetch_data_from_remote(socket);
                });
                
                socket.addEventListener("close", (ev) => {
                    connected = false;
                    simcore_ws = undefined;
                    let l = $(".depend-on-signal-data");
                    console.log(l);
                    for (let e of l) {
                        $(e).addClass("waiting-for-data");
                    }
                    for (let s of signals) {
                        s.value = undefined;
                    }
                    setTimeout(() => { for (let e of l) update_widget_ctrl($(e)); }, 10);
                    show_failed_connect_notification(url);
                });
                socket.addEventListener("error", (ev) => { connected = false; simcore_ws = undefined; });                
            })();
        }

        function login(url) {
            $('#dlg_login').modal('hide');
            do_login(url);
        }


        
        $(document).ready(() => {
            //$(document).click(() => { $(".baseWidget-selected").removeClass("baseWidget-selected"); });
            init_widget_properties_panel();
            setInterval(() => {
                for (let e of global_observer_handlers) if (e.handler != undefined) e.handler();
             } , 10);

            setInterval(() => {
                
                let not_connected_widgets = $(".waiting-for-data");
                if (not_connected_widgets.length && connected && simcore_ws) {
                    console.log(not_connected_widgets);
                    for (let e of not_connected_widgets) {
                        let signal_name = $(e).attr("attached-signal");
                        let sig = get_signal_by_name(signal_name);
                        if (sig.value != undefined) {
                            $(e).removeClass("waiting-for-data");
                            setTimeout(() => { update_widget_ctrl($(e)); }, 10);
                        } else simcore_ws.send("WATCH "+signal_name);
                    }                    
                }
            } , 500);    
            
            ctrlPanelEditor = new CtrlPanelEditor($('#ctrl_panel_editor'), new CtrlPanelComponentTemplates() );
            $('#ctrl_panel_editor_btn_add').on('click', (ev) => {
                ctrlPanelEditor.addWidget();
            });
            $('#ctrl_panel_editor_btn_add_paragraph').on('click', (ev) => {
                ctrlPanelEditor.addParagraph();
            });
            if (!connected)
                setTimeout(() => {
                    $('#dlg_login').modal('show');
                }, 100);
        });
    </script>
</body>

</html>